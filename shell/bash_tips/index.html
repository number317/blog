<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/shell/>shell</a></li><li class=active>»
<a href=https://number317.github.io/blog/shell/bash_tips/>Bash Tips</a></li></ul><div id=content><main id=main><h1>Bash Tips</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#大规则>大规则</a></li><li><a href=#最佳练习和提示>最佳练习和提示</a></li><li><a href=#有用的参考和帮助>有用的参考和帮助</a></li><li><a href=#例子>例子</a></li></ul></nav></aside><article id=content><h1 id=bash-代码规范建议>bash 代码规范建议</h1><p>Bash 可以认为是系统编程级的 JavaScript。虽然在某些时候，使用一门像 C，Go 之类的系统语言是一个更好的选择，但是对于一些小的POSIX相关或命令行任务，Bash 是一门理想的系统语言。这里有几个原因：</p><ul><li>Bash 无处不在。就像 web 上的 JavaScript，Bash 早就在系统上为系统编程准备好了。</li><li>Bash 可以作为粘合剂。用 C 或 Go （或者其他任意语言）来编写复杂的部分，然后用 Bash 将它们粘合在一起。</li></ul><p>这篇文章记录了一些 Bash 脚本的代码规范。这些规范基于大量的经验和时间收集的最佳实践。注意这篇文章不是针对 shell 脚本写的，这些规则只针对 Bash 脚本。</p><h2 id=大规则>大规则</h2><p>使用双引号，包括子 shell，不要使用裸露的 <code>$</code>。这条规则可以让你走得更远。阅读<a href=http://mywiki.wooledge.org/Quotes>http://mywiki.wooledge.org/Quotes</a>查看更多细节。</p><p>所有的代码都写入一个函数中，哪怕只有一个函数<code>main</code>。除非该脚本是用作库文件，否则你可以编写‘main’函数并且调用它。</p><p>避免使用全局变量。定义常量时使用<code>readonly</code>。</p><p>在可执行脚本中使用<code>main</code>函数，用<code>main</code>或者<code>main "$@"</code>来调用。如果脚本也是可以作为库文件使用的，用<code>[[ "$0" == "$BASH_SOURCE" ]] && main "$@"</code>。</p><p>使用<code>local</code>来定义变量，除了有另外的原因使用<code>declare</code>。除了罕见的情况特意在范围外设置变量。</p><p>变量名应该设置为小写，除非导出为环境变量。</p><p>使用<code>set -eo pipefail</code>。快速失败并注意退出状态码。</p><p>在程序中使用<code>|| true</code>如果你有意要以非0值退出</p><p>不要使用已弃用的语法。尤其是以下几点：</p><ul><li>定义函数用<code>myfunc() { ... }</code>，而不是<code>function myfunc { ... }</code>。</li><li>使用<code>[[</code>代替<code>[</code>或<code>test</code>。</li><li>不要使用倒引号，使用<code>$( ... )</code>。</li><li><a href=http://wiki.bash-hackers.org/scripting/obsolete>http://wiki.bash-hackers.org/scripting/obsolete</a>记录了一些额外的注意点。</li></ul><p>尽量使用绝对路径，使用相对路径时，加上<code>./</code>。</p><p>如果函数超过二行，在函数顶部使用<code>declare</code>并命名变量参数。例如：<code>declare arg1="$1" arg2="$2"</code>。例外是定义可变参数函数。</p><p>为临时文件使用<code>mktemp</code>，用<code>trap</code>来清理。</p><p>警告和错误应该输出到STDERR，任何与之相对的东西都应该输出倒STDOUT。</p><p>尝试去本地化<code>shopt</code>的使用并且在结束时禁用选项。</p><p><strong>如果你知道你在做什么，你可以打破这些规则，但通常来说，这些规则是对的并且非常有用。</strong></p><h2 id=最佳练习和提示>最佳练习和提示</h2><ul><li>如果可以的话，在awk/sed之前使用Bash变量替换。</li><li>尽量使用双括号除非使用单括号更有意义。</li><li>对于简单的条件判断，请使用<code>&&</code>和<code>||</code>。</li><li>不要害怕使用<code>printf</code>，它比<code>echo</code>更加强大。</li><li>把<code>then</code>，<code>do</code>等放在同一行，而不是换一行。</li><li>如果可以测试退出代码，在你的if表达式中跳过<code>[[ ... ]]</code>。</li><li>使用<code>.sh</code>或<code>.bash</code>扩展名如果一个文件要被用于included/sourced。不要在可执行脚本中使用。</li><li>把复杂的<code>sed</code>，<code>perl</code>等代码放在一个名字有意义的函数下。</li><li>脚本中包含<code>[[ "$TRACE" ]] && set -x</code>是一个好习惯。</li><li>脚本的设计应该遵循简单和易于使用的原则。<ul><li>避免选项标记和解析，尝试使用可选的环境变量来代替。</li><li>对于必要的不同模式使用子命令。</li></ul></li><li>在大系统或任何CLI命令，为功能添加一个描述。<ul><li>在函数的最上方使用<code>declare desc="description"</code>，即使是在参数声明之前。</li><li>这可以用一个利用反射的简单函数来查询/提取。</li></ul></li><li>要注意可移植性。在容器中运行Bash可以比在多个平台上运行的Bash做更多的假设。</li><li>当预期或导出环境时，考虑在可能涉及子shell时使用命名空间变量。</li></ul><h2 id=有用的参考和帮助>有用的参考和帮助</h2><ul><li><a href=http://wiki.bash-hackers.org/scripting/obsolete>http://wiki.bash-hackers.org/scripting/obsolete</a></li><li><a href=http://wiki.bash-hackers.org/scripting/newbie_traps>http://wiki.bash-hackers.org/scripting/newbie_traps</a></li><li><a href=http://tldp.org/LDP/abs/html/>http://tldp.org/LDP/abs/html/</a></li><li>交互式Bash的提示: <a href=http://samrowe.com/wordpress/advancing-in-the-bash-shell/>http://samrowe.com/wordpress/advancing-in-the-bash-shell/</a></li><li>用于参考, <a href=https://google.github.io/styleguide/shell.xml>Google&rsquo;s Bash styleguide</a></li><li><a href=https://github.com/koalaman/shellcheck>shellcheck</a></li></ul><h2 id=例子>例子</h2><p>带有参数的函数定义：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>regular_func() {
</span></span><span style=display:flex><span>	<span style=font-weight:700;font-style:italic>declare</span> <span style=color:#666;font-weight:700;font-style:italic>arg1</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$1</span><span style=color:#666;font-style:italic>&#34;</span> <span style=color:#666;font-weight:700;font-style:italic>arg2</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$2</span><span style=color:#666;font-style:italic>&#34;</span> <span style=color:#666;font-weight:700;font-style:italic>arg3</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$3</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic># ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>带有最后可变参数的函数定义：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>variadic_func() {
</span></span><span style=display:flex><span>	<span style=font-weight:700;font-style:italic>local</span> <span style=color:#666;font-weight:700;font-style:italic>arg1</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$1</span><span style=color:#666;font-style:italic>&#34;</span>; <span style=font-weight:700;font-style:italic>shift</span>
</span></span><span style=display:flex><span>	<span style=font-weight:700;font-style:italic>local</span> <span style=color:#666;font-weight:700;font-style:italic>arg2</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$1</span><span style=color:#666;font-style:italic>&#34;</span>; <span style=font-weight:700;font-style:italic>shift</span>
</span></span><span style=display:flex><span>	<span style=font-weight:700;font-style:italic>local</span> <span style=color:#666;font-weight:700;font-style:italic>rest</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$@</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic># ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>条件语句：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep ^root: /etc/passwd &gt;/dev/null 2&gt;&amp;1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>if</span> [ <span style=color:#666;font-weight:700;font-style:italic>$?</span> -neq 0 ]; <span style=font-weight:700>then</span>
</span></span><span style=display:flex><span>  <span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;root was not found - check the pub at the corner&#34;</span>
</span></span><span style=display:flex><span><span style=font-weight:700>fi</span>
</span></span></code></pre></div><p>可以简化为</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep ^root: /etc/passwd &gt;/dev/null 2&gt;&amp;1 || <span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;root was not found - check the pub at the corner&#34;</span>
</span></span></code></pre></div></article></div></main><div><h4 id=signature>Tue Oct 10, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/bash>bash</a></li></ul><ul class=related><li><a class=next href=https://number317.github.io/blog/shell/bash_expansion/>Bash Expansion</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>