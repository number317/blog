<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/shell/>shell</a></li><li class=active>»
<a href=https://number317.github.io/blog/shell/es_clean_indices/>Es Clean Indices</a></li></ul><div id=content><main id=main><h1>Es Clean Indices</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#获取索引>获取索引</a></li><li><a href=#编写脚本>编写脚本</a></li><li><a href=#配置定时任务>配置定时任务</a></li></ul></nav></aside><article id=content><h1 id=es-清理索引>ES 清理索引</h1><p>使用阿里云的 ES 服务存储应用的日志，随着业务的增长和 ES 的资源限制，索引过多会引起 ES 的崩溃。
日志的采集是通过 logback 发送到 kafka，再用 logstash 消费 kafka 并转发给 ES。logstash 配置了<code>%{[@metadata][kafka][topic]}-%{+YYYY-MM-dd}</code>作为 ES 的索引。
经过讨论准备只将日志存储一个月，需要定时去清理索引，防止索引过多。</p><h2 id=获取索引>获取索引</h2><p>首先要做的是获取当前的索引，通过查阅 ES 的 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html>API</a> 可知，可以用 <code>/_cat/indices</code> 接口来获取所有索引:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST -s <span style=color:#666;font-style:italic>&#34;http://es.example.site/_cat/indices&#34;</span>
</span></span></code></pre></div><p>可以看到如下结果:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>green open test-app1-prod-log-2019-06-11      28NbwQbZTIaGPgb0S5Wkuw 5 1  189385 0 179.7mb  89.9mb
</span></span><span style=display:flex><span>green open test-app1-prod-log-2019-06-10      0EiQBNhZTnGZqUZ92J9UEg 5 1  189385 0 179.7mb  93.3mb
</span></span><span style=display:flex><span>green open test-app2-prod-log-2019-06-08      N_Th5gahSiu3kiycF26Q_A 5 1 2133105 0   4.5gb   2.2gb
</span></span></code></pre></div><p>需要将结果过滤一下，只保留 <code>%{[@metadata][kafka][topic]}</code> 的信息:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST -s <span style=color:#666;font-style:italic>&#34;http://es.example.site/_cat/indices&#34;</span> | awk <span style=color:#666;font-style:italic>&#39;{print $3}&#39;</span> | sort | grep -oP <span style=color:#666;font-style:italic>&#34;.*(?=-[0-9]*-[0-9]*-[0-9]*)&#34;</span> | uniq
</span></span></code></pre></div><p>得到如下结果:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>test-app1-prod-log
</span></span><span style=display:flex><span>test-app2-prod-log
</span></span></code></pre></div><h2 id=编写脚本>编写脚本</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#888;font-weight:700>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#888;font-weight:700></span><span style=color:#666;font-weight:700;font-style:italic>es_addr</span>=<span style=color:#666;font-style:italic>&#34;http://es.example.site&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>date</span>=<span style=font-weight:700>$(</span>date -d <span style=color:#666;font-style:italic>&#34;30 days ago&#34;</span> +%Y-%m-%d<span style=font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>indices</span>=(
</span></span><span style=display:flex><span>    <span style=color:#666;font-style:italic>&#34;test-app1-prod-log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#666;font-style:italic>&#34;test-app2-prod-log&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>date
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>for</span> index in <span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>indices</span>[@]<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>; <span style=font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;------------------------------------------&#34;</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>es_addr</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>/</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>index</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>-</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>date</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;close ...&#34;</span>
</span></span><span style=display:flex><span>    curl -X POST -s <span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>es_addr</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>/</span><span style=color:#666;font-weight:700;font-style:italic>$index</span><span style=color:#666;font-style:italic>-</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>date</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>/_close&#34;</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;delete ...&#34;</span>
</span></span><span style=display:flex><span>    curl -X DELETE -s <span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>es_addr</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>/</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>index</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>-</span><span style=color:#666;font-style:italic>${</span><span style=color:#666;font-weight:700;font-style:italic>date</span><span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span> &amp;&amp; <span style=font-weight:700;font-style:italic>echo</span> || <span style=font-weight:700;font-style:italic>echo</span> failed
</span></span><span style=display:flex><span><span style=font-weight:700>done</span>
</span></span></code></pre></div><p>如果 ES 配置了允许用通配符来匹配 topic，在脚本的<code>indices</code>索引中可以用<code>*</code>来通配索引。如果在不允许通配的 ES 中使用通配符，请求会返回错误提示。</p><h2 id=配置定时任务>配置定时任务</h2><p>运行<code>crontab -e</code>编辑定时任务，添加如下任务:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>0 1 * * * /path/to/delete_es_index.sh 2&gt;&amp;1 &gt;&gt; /path/to/es_clear.log
</span></span></code></pre></div><p>这样每天凌晨一点会自动删除距离今天30天的索引</p></article></div></main><div><h4 id=signature>Wed Jun 12, 2019
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/es>es</a></li><li><a href=https://number317.github.io/blog/tags/curl>curl</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/shell/interesting_shell_commands/>Interesting Shell Commands</a></li><li><a class=next href=https://number317.github.io/blog/shell/dockerfile_tips/>Dockerfile Tips</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>