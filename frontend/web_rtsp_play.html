<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="description" content=Aloha!&#32;Welcome&#32;to&#32;cheon&#39;s&#32;blog.>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes= "76x76" href=https://number317.github.io/blog/img/apple-touch-icon.png>
    <link rel="icon" href=https://number317.github.io/blog/img/pen.svg>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/global.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/nav.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/header.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/index.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/list.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/single.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/footer.css>
    
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel="stylesheet">
    
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>cheon&#39;s blog</title>

</head>
<body><section id="header">
    <ul id="menus">
    
    <li class="menu"><a href="https://number317.github.io"><span>Home</span></a></li>
    
    <li class="menu"><a href="https://number317.github.io/blog/categories"><span>Categories</span></a></li>
    
    <li class="menu"><a href="https://number317.github.io/blog/tags"><span>Tags</span></a></li>
    
    <li class="menu"><a href="https://github.com/number317"><span>Projects</span></a></li>
    
    </ul>
    <h1 id="title"><a href="https://number317.github.io/blog/">cheon&#39;s blog</a></h1>
</section>
<ul id="nav">






<li>
    »
    <a href="https://number317.github.io/blog/">
    
    cheon&#39;s blog
    
    </a>
</li>


<li>
    »
    <a href="https://number317.github.io/blog/categories/frontend/">
    
    frontend
    
    
    </a>
</li>


<li class="active">
    »
    <a href="https://number317.github.io/blog/frontend/web_rtsp_play.html">
    
    Web Rtsp Play
    
    </a>
</li>

</ul>

<div id="content">
<main id="main">
  <h1>Web Rtsp Play</h1>
  <time>Last updated Sun May 7, 2023</time>
  <div>
      <aside>
          <h2>Table of Content</h1>
          <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">前端播放 rtsp 视频流方案</a>
<ul>
<li><a href="#headline-2">转码服务</a>
</li>
<li><a href="#headline-3">前端播放</a>
</li>
<li><a href="#headline-4">注意事项</a>
</li>
</ul>
</li>
</ul>
</nav>
      </aside>
      <article id="content">
          
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
前端播放 rtsp 视频流方案
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
最近遇到一个需求，办公室里装了很多摄像头，视频采集统一存储到华为的 <a href="https://support.huawei.com/enterprise/zh/intelligent-vision/nvr800-pid-250982959"><code class="verbatim">NVR800</code></a> 硬盘录像机中，录像机自带 api 接口提供实时视频和回看视频的地址。
可惜格式是 rtsp 视频流，没法在网页中直接播放。在技术支持的群里问了管理员也说没有网页端播放的方案，那只能自己找了。</p>
<p>
网上找了一圈很多都是较老的技术了，有用老版本的 chrome 安装 vlc 插件的来播放的，有用 flash 来播放的，而且很多博客抄来抄去都差不多。</p>
<p>
最后找到两个看着靠谱的方案：</p>
<ul>
<li>一种是用 <code class="verbatim">ffmpeg</code> 的 <code class="verbatim">wasm</code> 版直接前端解析转码 <code class="verbatim">rtsp</code> 视频流，转成前端能直接播放的格式</li>
<li>第二种是写一个服务还是调用 <code class="verbatim">ffmpeg</code> 将 <code class="verbatim">rtsp</code> 视频流转码，给前端返回新的视频地址</li>
</ul>
<p>看到这两个方案我感觉第二种是肯定行得通的，第一种方案暂时不清楚，没怎么用过前端 wasm 技术，只能再去搜索一下。</p>
<p>
针对第一种方案，去 <a href="https://github.com/ffmpegwasm/ffmpeg.wasm/issues/67#issuecomment-721452717"><code class="verbatim">github</code></a> 上搜索了一下看看别人有没有用这个的，结果发现暂时还不支持 rtsp 视频流，这是2020年11月4号的回复，后续也没见有啥更新，当他暂时不支持，那就选第二种方案。</p>
<p>
方案二的实现就分两步：</p>
<ul>
<li>首先是转码，想着可以用 java 调用 ffmpeg 来实现，但是要转成什么视频流又没有思路。</li>
<li>第二步就是找前端能播放视频流的插件，转码的最终目的是为了前端网页中能播放，所以先看看有什么播放器能支持什么格式。</li>
</ul>
<p>之前在很多网站看视频的时候发现网页端播放的视频很多都以 m3u8 结尾的。
之前好奇下载过发现这是一个文件，里面记录了很多视频分片，最后查了知道这个叫 hls，搜索了之后找到了网页播放 hls 的插件 <a href="https://github.com/video-dev/hls.js">hls.js</a>。
所以现在目标就明确了，首先将 rtsp 转成 hls, 再用 hls.js 来播放。</p>
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
转码服务
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<p>
一开始想着自己用 java 调用 ffmpeg 来做转码服务，实现起来应该也不难，但想着这种应该是比较常见的需求，看看有没有轮子。
经过一番搜索，还真找到了一个 <a href="https://github.com/Roverr/rtsp-stream.git">rtsp-stream</a>，真的是帮了大忙，节约了好多时间，感谢开源大佬的无私奉献。
这个就是正好完全解决了我的需求，而且是用 Go 写的，部署简单，跨平台，而且作者还很贴心的构建了 Docker 镜像。</p>
<p>
根据文档介绍，转换接口是 <code class="verbatim">start</code> 接口，会返回一个 m3u8 的链接，前端播放器只需要播放这个链接就行。
这些都可以交给后端来实现，后端只需要暴露一个接口返回一个 m3u8 的链接即可。流程如下：</p>
<p>
<img src="./images/web_rtsp_play_1.png" alt="./images/web_rtsp_play_1.png" title="./images/web_rtsp_play_1.png" /></p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
前端播放
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<p>
这里用的是 react, 用 vue 或者别的应该差不多，首先是加载 hls.js 插件</p>
<details>
<summary>load hls.js</summary>
<div class="src src-javascript">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  useEffect(() =&gt; {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> (hlsRef.current) {
</span></span><span style="display:flex;"><span>      hlsRef.current.detachMedia();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    setLoading(<span style="font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stopVideo();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> meta = <span style="font-weight:bold;font-style:italic">document</span>.createElement(<span style="color:#666;font-style:italic">&#39;meta&#39;</span>);
</span></span><span style="display:flex;"><span>    meta.name = <span style="color:#666;font-style:italic">&#39;referrer&#39;</span>;
</span></span><span style="display:flex;"><span>    meta.content = <span style="color:#666;font-style:italic">&#39;no-referrer&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">document</span>.getElementsByTagName(<span style="color:#666;font-style:italic">&#39;head&#39;</span>)[0].appendChild(meta);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> script = <span style="font-weight:bold;font-style:italic">document</span>.createElement(<span style="color:#666;font-style:italic">&#39;script&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> (script.readyState) {
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">// IE
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>      script.onreadystatechange = () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> (script.readyState === <span style="color:#666;font-style:italic">&#39;loaded&#39;</span> || script.readyState === <span style="color:#666;font-style:italic">&#39;complete&#39;</span>) {
</span></span><span style="display:flex;"><span>          script.onreadystatechange = <span style="font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>          initVideo();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    } <span style="font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">// 其他浏览器
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>      script.onload = () =&gt; {
</span></span><span style="display:flex;"><span>        initVideo();
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    script.src = <span style="color:#666;font-style:italic">&#39;https://cdn.jsdelivr.net/npm/hls.js@latest&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">document</span>.getElementsByTagName(<span style="color:#666;font-style:italic">&#39;head&#39;</span>)[0].appendChild(script);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> () =&gt; {
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">if</span> (hlsRef.current) {
</span></span><span style="display:flex;"><span>        hlsRef.current.detachMedia();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stopVideo();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }, []);</span></span></code></pre></div>
</div>
</details>
<p>
<code class="verbatim">initVideo()</code> 方法就是具体要设置播放的操作，首先是获取播放地址，然后再将 hls 实例绑定到 <code class="verbatim">video</code> 标签上。</p>
<details>
<summary>initVideo()</summary>
<div class="src src-javascript">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">function</span> initVideo() {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> requestBody = { cameraCode: <span style="color:#666;font-style:italic">&#39;1&#39;</span> };
</span></span><span style="display:flex;"><span>    axios.post(<span style="color:#666;font-style:italic">&#39;/video/get-url&#39;</span>, requestBody).then(res =&gt; {
</span></span><span style="display:flex;"><span>      setUrlInfo(res);
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">const</span> video = <span style="font-weight:bold;font-style:italic">document</span>.getElementById(<span style="color:#666;font-style:italic">&#39;realTime&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">const</span> videoSrc = res.uri;
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">if</span> (<span style="font-weight:bold;font-style:italic">window</span>.Hls.isSupported()) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">const</span> hls = <span style="font-weight:bold">new</span> <span style="font-weight:bold;font-style:italic">window</span>.Hls();
</span></span><span style="display:flex;"><span>        hlsRef.current = hls;
</span></span><span style="display:flex;"><span>        hls.loadSource(videoSrc);
</span></span><span style="display:flex;"><span>        hls.attachMedia(video);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      setLoading(<span style="font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>    }).<span style="font-weight:bold">catch</span>(e =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#888;font-style:italic">// eslint-disable-next-line no-console
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>      console.log(<span style="color:#666;font-style:italic">&#39;err: &#39;</span>, e.message);
</span></span><span style="display:flex;"><span>      message.error(<span style="color:#666;font-style:italic">&#39;获取本地视频失败&#39;</span>);
</span></span><span style="display:flex;"><span>      setLoading(<span style="font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
</div>
</details>
<p>
最后是加上一个 <code class="verbatim">video</code> 标签：</p>
<div class="src src-javascript">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>&lt;video id=<span style="color:#666;font-style:italic">&#34;realTime&#34;</span> controls=<span style="color:#666;font-style:italic">&#34;controls&#34;</span> className={<span style="color:#666;font-style:italic">`</span><span style="color:#666;font-style:italic">${</span>prefixCls<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">-video`</span>} /&gt;</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
注意事项
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<ul>
<li>hls.js 只支持 H.264 编码的视频，不支持 H.265 编码的视频。

如果遇到转码没问题，返回的链接能在 vlc 等播放器播放，但在网页中进度条正常，就是黑屏无图像时，可以去 nvr800 查看一下视频编码。</li>
<li>结束播放时可以给服务器发送一个请求停止转码，避免浪费资源。</li>
</ul>
</div>
</div>
</div>
</div>

      </article>
  </div>
</main>

<div>
    <h4 id="signature">
        Tue Aug 31, 2021
        
            cheon
        
    </h4>
    
    
    <ul class="tags">
        
            <li> <a href="https://number317.github.io/blog/tags/video">video</a> </li>
        
            <li> <a href="https://number317.github.io/blog/tags/rtsp">rtsp</a> </li>
        
            <li> <a href="https://number317.github.io/blog/tags/ffmpeg">ffmpeg</a> </li>
        
    </ul>
    
    <ul class="related">
        
        
            <li><a class="next" href="https://number317.github.io/blog/frontend/react_native_launcher.html"> React Native Launcher</a></li>
        
    </ul>
</div>

        </div><section id="footer">

<div id="author">
    <h2>About Author</h2>
    <hr>
    <img src=https://number317.github.io/images/author.jpg></img>
    <p>Life is dance we all have to do.</p>
</div>
<ul id="link">
    <li><a href=https://github.com/number317/aloha.git target="_blank"><i class="fa fa-github" alt="github"></i></a></li>
    <li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target="_blank"><i class="fa fa-envelope" alt="email"></i></a></li>
    <li id="wechat"><i class="fa fa-wechat"></i></li>
    <img class="qrcode" src=https://number317.github.io/images/wechat.jpg>
</ul>
</section>
</body>
</html>
