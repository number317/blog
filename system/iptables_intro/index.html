<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/system/>system</a></li><li class=active>»
<a href=https://number317.github.io/blog/system/iptables_intro/>Iptables Intro</a></li></ul><div id=content><main id=main><h1>Iptables Intro</h1><time>Last updated Wed Sep 18, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#基本概念>基本概念</a></li><li><a href=#工作流程>工作流程</a></li><li><a href=#常用选项>常用选项</a></li><li><a href=#配置运行>配置运行</a></li><li><a href=#查看规则>查看规则</a></li><li><a href=#filter-表-input-链>filter 表 INPUT 链</a></li><li><a href=#filter-表-output-链>filter 表 OUTPUT 链</a></li><li><a href=#filter-表-forward-链>filter 表 FORWARD 链</a></li><li><a href=#nat-表转发>nat 表转发</a></li><li><a href=#具体使用场景>具体使用场景</a></li></ul></nav></aside><article id=content><h1 id=iptables-介绍>iptables 介绍</h1><h2 id=基本概念>基本概念</h2><ul><li>iptables 可以检测、修改、转发、重定向和丢弃IPV4数据包。</li><li>表(tables)<ul><li>raw: 用于配置数据包</li><li>filter: 存放所有与防火墙相关操作的表</li><li>nat: 用于网络地址转换</li><li>mangle: 用于对特定数据包的修改</li><li>security: 用于强制访问控制</li></ul></li><li>链(chains): INPUT, OUTPUT, FORWARD, PREROUTING,POSTROUTING</li><li>规则(rules): 过滤数据包</li><li>模块(modules): 用于扩展iptables，进行更复杂的过滤</li></ul><h2 id=工作流程>工作流程</h2><p><img src=https://number317.github.io/blog/system/images/iptables_intro_img1.jpg alt="iptables 流程图"></p><p>第一个路由策略包括决定数据包的目的地是本地主机（这种情况下，数据包穿过 INPUT 链），还是其他主机（数据包穿过 FORWARD 链）；</p><p>中间的路由策略包括决定给传出的数据包使用那个源地址、分配哪个接口；</p><p>最后一个路由策略存在是因为 mangle 与 nat 链可能会改变数据包的路由信息。</p><p>数据包通过路径上的每一条链时，链中的每一条规则按顺序匹配；无论何时匹配了一条规则，相应的 target/jump 动作将会执行。最常用的3个 target 是 ACCEPT, DROP ,或者 jump 到用户自定义的链。内置的链有默认的策略，但是用户自定义的链没有默认的策略。在 jump 到的链中，若每一条规则都不能提供完全匹配，那么数据包返回到调用链。在任何时候，若 DROP target 的规则实现完全匹配，那么被匹配的数据包会被丢弃，不会进行进一步处理。如果一个数据包在链中被 ACCEPT，那么它也会被所有的父链 ACCEPT，并且不再遍历其他父链。然而，要注意的是，数据包还会以正常的方式继续遍历其他表中的其他链。</p><h2 id=常用选项>常用选项</h2><table><thead><tr><th style=text-align:left>参数类型</th><th style=text-align:right>可选项</th></tr></thead><tbody><tr><td style=text-align:left>表</td><td style=text-align:right>filter, nat&mldr;</td></tr><tr><td style=text-align:left>链</td><td style=text-align:right>INPUT, OUTPUT, FORWARD, PREOUTING（修改目标ip地址）, POSTROUTING（修改源ip地址）&mldr;</td></tr><tr><td style=text-align:left>匹配属性</td><td style=text-align:right>源、目标IP，协议（TCP,UDP,ICMP&mldr;），端口号，网卡接口&mldr;</td></tr><tr><td style=text-align:left>模块</td><td style=text-align:right>conntrack, multiport, connlimit&mldr;</td></tr><tr><td style=text-align:left>动作</td><td style=text-align:right>ACCEPT, DROP, RETURN, REJECT&mldr;</td></tr></tbody></table><h2 id=配置运行>配置运行</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#888;font-style:italic># systemctl start iptables</span>
</span></span></code></pre></div><p>启动时会读取<code>/etc/iptables/iptables.rules</code>文件载入规则，如果配置文件不存在会报错
可以直接生成一个空的iptables.rules文件设定空规则<code>touch /etc/iptables/iptables.rules</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#888;font-style:italic># systemctl stop iptables</span>
</span></span></code></pre></div><p>停止iptables服务</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#888;font-style:italic># systemctl restart iptables</span>
</span></span></code></pre></div><p>重启iptables服务</p><h2 id=查看规则>查看规则</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -nvL --line-number
</span></span></code></pre></div><p>显示当前规则，没有指定表，默认使用filter表。<code>-n</code> 以端口号数字形式显示，<code>-v</code> 显示详细信息，<code>-- line-number</code> 显示规则的行号</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t nat -S
</span></span></code></pre></div><p>以保存的格式列出nat表当前规则，个人认为，用<code>-S</code>选项查看规则更清晰</p><h2 id=filter-表-input-链>filter 表 INPUT 链</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t filter -A INPUT -s 172.17.0.2 -j DROP
</span></span></code></pre></div><p><code>-A</code> append 追加规则，来自172.17.0.2的包全部丢弃</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -I INPUT -p tcp --dport 22 -j ACCEPT
</span></span></code></pre></div><p><code>-I</code> insert 插入规则，允许ssh远程连接</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -P INPUT DROP
</span></span></code></pre></div><p><code>-P</code> policy 设置内置链的默认策略，ACCEPT或DROP</p><h2 id=filter-表-output-链>filter 表 OUTPUT 链</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t filter -I OUTPUT 3 -o docker0 -j REJECT
</span></span></code></pre></div><p>REJECT会返回信息，DROP直接丢弃，无返回信息，主机无法访问容器环境</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -I OUTPUT -d www.baidu.com -j REJECT
</span></span></code></pre></div><p>让主机无法访问www.baidu.com这个地址</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -I OUTPUT -d www.baidu.com -p icmp -j DROP
</span></span></code></pre></div><p>让主机无法ping通www.baidu.com，但可以访问</p><h2 id=filter-表-forward-链>filter 表 FORWARD 链</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -A FORWARD -s 172.17.0.2 -d 172.17.0.3 -j DROP
</span></span></code></pre></div><p>禁止来自172.17.0.2的数据发送给172.17.0.3</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -I FORWARD -i docker0 -o docker0 -j DROP
</span></span></code></pre></div><p>禁止容器间互相访问</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -I FORWARD -i docker0 -o wlp2s0 -p tcp --dport 80 -j DROP
</span></span></code></pre></div><p>禁止容器访问外网http协议的网站，但可以访问https协议的网站</p><h2 id=nat-表转发>nat 表转发</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t nat -A OUTPUT -p tcp --dport 1080 -j DNAT --to-dest 127.0.0.1:8000
</span></span></code></pre></div><p>使用nat表的OUTPUT链来做本地端口转发，使用tcp协议，目的端口是1080的流量全都转发到8000端口</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t nat -I PREROUTING -p tcp -d 192.168.0.110 --dport 1080 -j DNAT --to-dest 192.168.0.110:8000
</span></span></code></pre></div><p>使用nat表的PREROUTING链来令远程访问本地1080端口的流量转发到本地的8000端口</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t nat -I PREROUTING -p tcp --dport 8080 -j DNAT --to-dest 10.0.52.190:8030
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t nat -I POSTROUTING -d 10.0.52.190 -p tcp --dport 8030 -j SNAT --to-source 10.72.19.213
</span></span></code></pre></div><p>通过PREROUTING和POSTROUTING链来做正向代理</p><h2 id=具体使用场景>具体使用场景</h2><p>在使用 iptables 之前，要先确保 iptables 服务已经启用，<code>systemctl start iptables.service</code></p><ul><li><p>容器运行时未暴露端口，又想让别人能通过本机 ip 访问到服务（假设本机 ip 是 10.72.19.213， 容器 ip 是 172.17.0.2）</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>iptables -t nat -I PREROUTING -p tcp --dport 8080 -j DNAT --to-dest 172.17.0.2:8080
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>iptables -t nat -I POSTROUTING -d 172.17.0.2 -p tcp --dport 8080 -j SNAT --to-source 10.72.19.213
</span></span></code></pre></div><p>上面两条规则设置的效果是从别的机器上访问 10.72.19.213:8080 会被转发到 172.17.0.2:8080，也就是容器里的服务。不过只能从别的机器上访问才有效。</p></li></ul></article></div></main><div><h4 id=signature>Thu Apr 26, 2018
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/iptables>iptables</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/system/dell_xps_15_9560_arch_linux_install/>Dell Xps 15 9560 Arch Linux Install</a></li><li><a class=next href=https://number317.github.io/blog/system/vps_openvpn/>Vps Openvpn</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>