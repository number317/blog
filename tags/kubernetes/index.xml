<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Kubernetes on cheon's blog</title><link>https://number317.github.io/blog/tags/kubernetes/</link><description>Recent content in Kubernetes on cheon's blog</description><generator>Hugo</generator><language>en</language><lastBuildDate>Tue, 17 Dec 2024 19:51:41 +0800</lastBuildDate><atom:link href="https://number317.github.io/blog/tags/kubernetes/index.xml" rel="self" type="application/rss+xml"/><item><title>Redis Somaxconn</title><link>https://number317.github.io/blog/solved/redis_somaxconn/</link><pubDate>Mon, 13 Aug 2018 11:07:55 +0800</pubDate><guid>https://number317.github.io/blog/solved/redis_somaxconn/</guid><description>&lt;h1 id="kubernetes-redis-最大连接数设置">kubernetes redis 最大连接数设置&lt;/h1>
&lt;p>应用在进行压力测试的时候发现请求多（5000并发）的时候会报出redis连接超时错误，查看了redis的配置，发现如下配置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fallback" data-lang="fallback">&lt;span style="display:flex;">&lt;span># TCP listen() backlog.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>#
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span># In high requests-per-second environments you need an high backlog in order
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span># to avoid slow clients connections issues. Note that the Linux kernel
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span># will silently truncate it to the value of /proc/sys/net/core/somaxconn so
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span># make sure to raise both the value of somaxconn and tcp_max_syn_backlog
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span># in order to get the desired effect.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tcp-backlog 511
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从这个配置可以看到，reids的最大连接数配置了511，所以应该将这个配置调高。注释里有提醒这个配置会受到linux内核配置的限制，查看&lt;code>/proc/sys/net/core/somaxconn&lt;/code>，发现这个值只有128，所以redis配置&lt;code>tcp-backlog 511&lt;/code>并没有生效，实际值只有128。&lt;/p>
&lt;p>由于这里的redis是通过kubernetes部署的，所以需要同时修改宿主机和容器的内核参数。由于集群中有许多主机，所以我们通过为三台节点添加标签和污点来搭建redis等中间件应用并且防止其他应用部署到这些节点。通过查阅资料发现要修改k8s部署的容器的内核参数，需要开启kubelet的配置。所以具体操作分为四步：&lt;/p>
&lt;ol>
&lt;li>为节点添加标签和污点&lt;/li>
&lt;li>修改主机内核参数&lt;/li>
&lt;li>修改kubelet配置&lt;/li>
&lt;li>修改容器内核参数&lt;/li>
&lt;li>修改redis配置并重启&lt;/li>
&lt;/ol>
&lt;h2 id="节点添加标签和污点">节点添加标签和污点&lt;/h2>
&lt;p>为节点添加标签：&lt;/p></description></item></channel></rss>