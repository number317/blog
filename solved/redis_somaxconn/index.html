<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><script src=https://number317.github.io/blog/js/single.js></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/solved/>solved</a></li><li class=active>»
<a href=https://number317.github.io/blog/solved/redis_somaxconn/>Redis Somaxconn</a></li></ul><div id=content><main id=main><h1>Redis Somaxconn</h1><time>Last updated Tue Dec 17, 2024</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#节点添加标签和污点>节点添加标签和污点</a></li><li><a href=#修改主机最大连接数设置>修改主机最大连接数设置</a></li><li><a href=#修改kubelet配置>修改kubelet配置</a></li><li><a href=#修改容器内核参数>修改容器内核参数</a></li><li><a href=#修改redis配置>修改redis配置</a></li></ul></nav></aside><article id=content><h1 id=kubernetes-redis-最大连接数设置>kubernetes redis 最大连接数设置</h1><p>应用在进行压力测试的时候发现请求多（5000并发）的时候会报出redis连接超时错误，查看了redis的配置，发现如下配置：</p><div class="code-block code-block-container-indented"><pre><code id=code-613973e7a69fce8ca9840d8695f0ce9b># TCP listen() backlog.
#
# In high requests-per-second environments you need an high backlog in order
# to avoid slow clients connections issues. Note that the Linux kernel
# will silently truncate it to the value of /proc/sys/net/core/somaxconn so
# make sure to raise both the value of somaxconn and tcp_max_syn_backlog
# in order to get the desired effect.
tcp-backlog 511</code></pre><button class=copy-code-button onclick='copyCode("code-613973e7a69fce8ca9840d8695f0ce9b",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>从这个配置可以看到，reids的最大连接数配置了511，所以应该将这个配置调高。注释里有提醒这个配置会受到linux内核配置的限制，查看<code>/proc/sys/net/core/somaxconn</code>，发现这个值只有128，所以redis配置<code>tcp-backlog 511</code>并没有生效，实际值只有128。</p><p>由于这里的redis是通过kubernetes部署的，所以需要同时修改宿主机和容器的内核参数。由于集群中有许多主机，所以我们通过为三台节点添加标签和污点来搭建redis等中间件应用并且防止其他应用部署到这些节点。通过查阅资料发现要修改k8s部署的容器的内核参数，需要开启kubelet的配置。所以具体操作分为四步：</p><ol><li>为节点添加标签和污点</li><li>修改主机内核参数</li><li>修改kubelet配置</li><li>修改容器内核参数</li><li>修改redis配置并重启</li></ol><h2 id=节点添加标签和污点>节点添加标签和污点</h2><p>为节点添加标签：</p><div class="code-block code-block-container-indented"><pre><code id=code-9d7a0fe8f76f9d1b3cd8f9bff43f4606>kubectl label node &lt;nodename&gt; middleware=true</code></pre><button class=copy-code-button onclick='copyCode("code-9d7a0fe8f76f9d1b3cd8f9bff43f4606",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这里为节点添加了<code>middleware=true</code>的标签。为了增加辨识度，可以给节点添加<code>middleware</code>的角色：</p><div class="code-block code-block-container-indented"><pre><code id=code-8425407aaf5cff20c685a25180879340>kubectl label node &lt;nodename&gt; node-role.kubernetes.io/middleware=&#34;&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-8425407aaf5cff20c685a25180879340",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这样在执行<code>kubectl get node</code>命令的时候可以清楚地看到哪三台是用于部署中间件的节点：</p><details><summary>kubectl get node</summary><div class="code-block code-block-container-indented"><pre><code id=code-93f84142f28f2405d2356a565bc93a42>NAME          STATUS    ROLES             AGE       VERSION
node1         Ready     master            186d      v1.8.5
node2         Ready     node              60d       v1.8.5
node3         Ready     node              60d       v1.8.5
node4         Ready     node              60d       v1.8.5
node5         Ready     node              60d       v1.8.5
node6         Ready     node              117d      v1.8.5
node7         Ready     master            186d      v1.8.5
node8         Ready     master            186d      v1.8.5
node9         Ready     node              34d       v1.8.5
node10        Ready     node              72d       v1.8.5
node11        Ready     node              72d       v1.8.5
node12        Ready     node              60d       v1.8.5
node13        Ready     middleware,node   19d       v1.8.5
node14        Ready     middleware,node   19d       v1.8.5
node15        Ready     middleware,node   19d       v1.8.5
node16        Ready     node              4d        v1.8.5
node17        Ready     node              123d      v1.8.5
node18        Ready     node              123d      v1.8.5</code></pre><button class=copy-code-button onclick='copyCode("code-93f84142f28f2405d2356a565bc93a42",this)' title=copy>
<i class="fa fa-copy"></i></button></div></details><p>为节点添加污点：</p><div class="code-block code-block-container-indented"><pre><code id=code-f84f9a0c851707ba30e93acc45949426>kubectl taint node &lt;nodename&gt; middleware=&#34;true&#34;:Noschedule</code></pre><button class=copy-code-button onclick='copyCode("code-f84f9a0c851707ba30e93acc45949426",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这样设置后在kubernetes部署应用时如果不指明忍受污点，那么应用是不会部署到这三个节点的。</p><h2 id=修改主机最大连接数设置>修改主机最大连接数设置</h2><p>修改<code>/etc/sysctl.d/99-sysctl.conf</code>文件，这里设置最大连接数为5000，在最后一行添加：</p><div class="code-block code-block-container-indented"><pre><code id=code-7f35c706ab47ebdab649e03ff34bd93b>net.core.somaxconn=5000</code></pre><button class=copy-code-button onclick='copyCode("code-7f35c706ab47ebdab649e03ff34bd93b",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>然后执行：</p><div class="code-block code-block-container-indented"><pre><code id=code-f75f8684c57bfaedb66fd9570a800555>sysctl -p</code></pre><button class=copy-code-button onclick='copyCode("code-f75f8684c57bfaedb66fd9570a800555",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>查看<code>/proc/sys/net/core/somaxconn</code>进行验证。</p><h2 id=修改kubelet配置>修改kubelet配置</h2><p>修改<code>/etc/systemd/system/kubelet.service.d/20-kubelet-override.conf</code>文件，在参数后面添加<code>--experimental-allowed-unsafe-sysctls='net.core.somaxconn'</code></p><div class="code-block code-block-container-indented"><pre><code id=code-a332d8e6cc7e89270a18c61da270f311>[Service]
Environment=&#34;KUBELET_EXTRA_ARGS=--pod-infra-container-image=www.private.com/google_containers/pause-amd64:3.0 --fail-swap-on=false --hostname-override=zdztvura16 --eviction-hard=memory.available&lt;1024Mi,nodefs.available&lt;10Gi,imagefs.available&lt;10Gi --eviction-minimum-reclaim=memory.available=500Mi,nodefs.available=5Gi,imagefs.available=5Gi --eviction-pressure-transition-period=5m0s --system-reserved=cpu=100m,memory=2Gi --experimental-allowed-unsafe-sysctls=&#39;net.core.somaxconn&#39;&#34;
Environment=&#34;KUBELET_DNS_ARGS=--cluster-dns=10.233.0.10 --cluster-domain=cluster.local&#34;
Environment=&#34;KUBELET_CADVISOR_ARGS=--cadvisor-port=4194&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-a332d8e6cc7e89270a18c61da270f311",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>重新启动kubelet：</p><div class="code-block code-block-container-indented"><pre><code id=code-45787458d841392b74a60a318a150fb2>systemctl daemon-reload
systemctl restart kubelet</code></pre><button class=copy-code-button onclick='copyCode("code-45787458d841392b74a60a318a150fb2",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=修改容器内核参数>修改容器内核参数</h2><p>修改redis的deployement配置：</p><details><summary>redis deployment</summary><div class="code-block code-block-container-indented"><pre><code id=code-e1acb0faa36e0793841c255c87a320a2>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: openapi-redis-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openapi-redis-dev
  template:
    metadata:
      annotations:
        security.alpha.kubernetes.io/unsafe-sysctls: net.core.somaxconn=2000
      labels:
        app: openapi-redis-dev
    spec:
      nodeSelector:
        middleware: &#34;true&#34;
      tolerations:
        - effect: NoSchedule
          key: middleware
          operator: Exists
      containers:
        - name: openapi-redis-dev
          image: &#39;www.private.com/tools/redis
          command:
          - /bin/sh
          - -c
          - redis-server /usr/local/etc/redis/redis.conf
          ports:
            - containerPort: 6379
              protocol: TCP
          resources:
            limits:
              cpu: &#39;2000m&#39;
              memory: 256Mi
            requests:
              cpu: 10m
              memory: 64Mi
          terminationMessagePath: /dev/termination-log
          imagePullPolicy: Always
          volumeMounts:
            - name: redis-data
              mountPath: /var/lib/redis
            - name: redis-conf
              mountPath: /usr/local/etc/redis/redis.conf
              subPath: redis.conf
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirst
      securityContext: {}
      volumes:
        - name: redis-data
          persistentVolumeClaim:
            claimName: openapi-redis-dev
        - name: redis-conf
          configMap:
            defaultMode: 420
            name: openapi-redis-dev-config
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1</code></pre><button class=copy-code-button onclick='copyCode("code-e1acb0faa36e0793841c255c87a320a2",this)' title=copy>
<i class="fa fa-copy"></i></button></div></details><p>这里添加了注解<code>security.alpha.kubernetes.io/unsafe-sysctls: net.core.somaxconn=2000</code>，设置最大连接数为2000，同时还添加了<code>nodeSelector</code>和<code>tolerations</code>用于选择部署节点。</p><h2 id=修改redis配置>修改redis配置</h2><p>修改redis对应的configMap，将<code>tcp-backlog</code>设置为2000，再重新部署redis。再此进行压力测试，可以发现有效果。</p></article></div></main><div><h4 id=signature>Mon Aug 13, 2018
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/redis>redis</a></li><li><a href=https://number317.github.io/blog/tags/kubernetes>kubernetes</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/solved/firefox_open_markdown/>Firefox Open Markdown</a></li><li><a class=next href=https://number317.github.io/blog/solved/connection_reset_error/>Connection Reset Error</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>