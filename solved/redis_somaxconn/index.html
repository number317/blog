<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/solved/>solved</a></li><li class=active>»
<a href=https://number317.github.io/blog/solved/redis_somaxconn/>Redis Somaxconn</a></li></ul><div id=content><main id=main><h1>Redis Somaxconn</h1><time>Last updated Tue Dec 17, 2024</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#节点添加标签和污点>节点添加标签和污点</a></li><li><a href=#修改主机最大连接数设置>修改主机最大连接数设置</a></li><li><a href=#修改kubelet配置>修改kubelet配置</a></li><li><a href=#修改容器内核参数>修改容器内核参数</a></li><li><a href=#修改redis配置>修改redis配置</a></li></ul></nav></aside><article id=content><h1 id=kubernetes-redis-最大连接数设置>kubernetes redis 最大连接数设置</h1><p>应用在进行压力测试的时候发现请求多（5000并发）的时候会报出redis连接超时错误，查看了redis的配置，发现如下配置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># TCP listen() backlog.
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span># In high requests-per-second environments you need an high backlog in order
</span></span><span style=display:flex><span># to avoid slow clients connections issues. Note that the Linux kernel
</span></span><span style=display:flex><span># will silently truncate it to the value of /proc/sys/net/core/somaxconn so
</span></span><span style=display:flex><span># make sure to raise both the value of somaxconn and tcp_max_syn_backlog
</span></span><span style=display:flex><span># in order to get the desired effect.
</span></span><span style=display:flex><span>tcp-backlog 511
</span></span></code></pre></div><p>从这个配置可以看到，reids的最大连接数配置了511，所以应该将这个配置调高。注释里有提醒这个配置会受到linux内核配置的限制，查看<code>/proc/sys/net/core/somaxconn</code>，发现这个值只有128，所以redis配置<code>tcp-backlog 511</code>并没有生效，实际值只有128。</p><p>由于这里的redis是通过kubernetes部署的，所以需要同时修改宿主机和容器的内核参数。由于集群中有许多主机，所以我们通过为三台节点添加标签和污点来搭建redis等中间件应用并且防止其他应用部署到这些节点。通过查阅资料发现要修改k8s部署的容器的内核参数，需要开启kubelet的配置。所以具体操作分为四步：</p><ol><li>为节点添加标签和污点</li><li>修改主机内核参数</li><li>修改kubelet配置</li><li>修改容器内核参数</li><li>修改redis配置并重启</li></ol><h2 id=节点添加标签和污点>节点添加标签和污点</h2><p>为节点添加标签：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label node &lt;nodename&gt; <span style=color:#666;font-weight:700;font-style:italic>middleware</span>=<span style=font-weight:700;font-style:italic>true</span>
</span></span></code></pre></div><p>这里为节点添加了<code>middleware=true</code>的标签。为了增加辨识度，可以给节点添加<code>middleware</code>的角色：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label node &lt;nodename&gt; node-role.kubernetes.io/middleware=<span style=color:#666;font-style:italic>&#34;&#34;</span>
</span></span></code></pre></div><p>这样在执行<code>kubectl get node</code>命令的时候可以清楚地看到哪三台是用于部署中间件的节点：</p><details><summary>kubectl get node</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME          STATUS    ROLES             AGE       VERSION
</span></span><span style=display:flex><span>node1         Ready     master            186d      v1.8.5
</span></span><span style=display:flex><span>node2         Ready     node              60d       v1.8.5
</span></span><span style=display:flex><span>node3         Ready     node              60d       v1.8.5
</span></span><span style=display:flex><span>node4         Ready     node              60d       v1.8.5
</span></span><span style=display:flex><span>node5         Ready     node              60d       v1.8.5
</span></span><span style=display:flex><span>node6         Ready     node              117d      v1.8.5
</span></span><span style=display:flex><span>node7         Ready     master            186d      v1.8.5
</span></span><span style=display:flex><span>node8         Ready     master            186d      v1.8.5
</span></span><span style=display:flex><span>node9         Ready     node              34d       v1.8.5
</span></span><span style=display:flex><span>node10        Ready     node              72d       v1.8.5
</span></span><span style=display:flex><span>node11        Ready     node              72d       v1.8.5
</span></span><span style=display:flex><span>node12        Ready     node              60d       v1.8.5
</span></span><span style=display:flex><span>node13        Ready     middleware,node   19d       v1.8.5
</span></span><span style=display:flex><span>node14        Ready     middleware,node   19d       v1.8.5
</span></span><span style=display:flex><span>node15        Ready     middleware,node   19d       v1.8.5
</span></span><span style=display:flex><span>node16        Ready     node              4d        v1.8.5
</span></span><span style=display:flex><span>node17        Ready     node              123d      v1.8.5
</span></span><span style=display:flex><span>node18        Ready     node              123d      v1.8.5
</span></span></code></pre></div></details><p>为节点添加污点：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl taint node &lt;nodename&gt; <span style=color:#666;font-weight:700;font-style:italic>middleware</span>=<span style=color:#666;font-style:italic>&#34;true&#34;</span>:Noschedule
</span></span></code></pre></div><p>这样设置后在kubernetes部署应用时如果不指明忍受污点，那么应用是不会部署到这三个节点的。</p><h2 id=修改主机最大连接数设置>修改主机最大连接数设置</h2><p>修改<code>/etc/sysctl.d/99-sysctl.conf</code>文件，这里设置最大连接数为5000，在最后一行添加：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>net.core.somaxconn=5000
</span></span></code></pre></div><p>然后执行：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl -p
</span></span></code></pre></div><p>查看<code>/proc/sys/net/core/somaxconn</code>进行验证。</p><h2 id=修改kubelet配置>修改kubelet配置</h2><p>修改<code>/etc/systemd/system/kubelet.service.d/20-kubelet-override.conf</code>文件，在参数后面添加<code>--experimental-allowed-unsafe-sysctls='net.core.somaxconn'</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Environment=&#34;KUBELET_EXTRA_ARGS=--pod-infra-container-image=www.private.com/google_containers/pause-amd64:3.0 --fail-swap-on=false --hostname-override=zdztvura16 --eviction-hard=memory.available&lt;1024Mi,nodefs.available&lt;10Gi,imagefs.available&lt;10Gi --eviction-minimum-reclaim=memory.available=500Mi,nodefs.available=5Gi,imagefs.available=5Gi --eviction-pressure-transition-period=5m0s --system-reserved=cpu=100m,memory=2Gi --experimental-allowed-unsafe-sysctls=&#39;net.core.somaxconn&#39;&#34;
</span></span><span style=display:flex><span>Environment=&#34;KUBELET_DNS_ARGS=--cluster-dns=10.233.0.10 --cluster-domain=cluster.local&#34;
</span></span><span style=display:flex><span>Environment=&#34;KUBELET_CADVISOR_ARGS=--cadvisor-port=4194&#34;
</span></span></code></pre></div><p>重新启动kubelet：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart kubelet
</span></span></code></pre></div><h2 id=修改容器内核参数>修改容器内核参数</h2><p>修改redis的deployement配置：</p><details><summary>redis deployment</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions/v1beta1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: openapi-redis-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: openapi-redis-dev
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      annotations:
</span></span><span style=display:flex><span>        security.alpha.kubernetes.io/unsafe-sysctls: net.core.somaxconn=2000
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: openapi-redis-dev
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      nodeSelector:
</span></span><span style=display:flex><span>        middleware: <span style=color:#666;font-style:italic>&#34;true&#34;</span>
</span></span><span style=display:flex><span>      tolerations:
</span></span><span style=display:flex><span>        - effect: NoSchedule
</span></span><span style=display:flex><span>          key: middleware
</span></span><span style=display:flex><span>          operator: Exists
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>        - name: openapi-redis-dev
</span></span><span style=display:flex><span>          image: <span style=color:#666;font-style:italic>&#39;www.private.com/tools/redis
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>          command:
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>          - /bin/sh
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>          - -c
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>          - redis-server /usr/local/etc/redis/redis.conf
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>          ports:
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>            - containerPort: 6379
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>              protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>          resources:
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>            limits:
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>              cpu: &#39;</span>2000m&#39;
</span></span><span style=display:flex><span>              memory: 256Mi
</span></span><span style=display:flex><span>            requests:
</span></span><span style=display:flex><span>              cpu: 10m
</span></span><span style=display:flex><span>              memory: 64Mi
</span></span><span style=display:flex><span>          terminationMessagePath: /dev/termination-log
</span></span><span style=display:flex><span>          imagePullPolicy: Always
</span></span><span style=display:flex><span>          volumeMounts:
</span></span><span style=display:flex><span>            - name: redis-data
</span></span><span style=display:flex><span>              mountPath: /var/lib/redis
</span></span><span style=display:flex><span>            - name: redis-conf
</span></span><span style=display:flex><span>              mountPath: /usr/local/etc/redis/redis.conf
</span></span><span style=display:flex><span>              subPath: redis.conf
</span></span><span style=display:flex><span>      restartPolicy: Always
</span></span><span style=display:flex><span>      terminationGracePeriodSeconds: 30
</span></span><span style=display:flex><span>      dnsPolicy: ClusterFirst
</span></span><span style=display:flex><span>      securityContext: {}
</span></span><span style=display:flex><span>      volumes:
</span></span><span style=display:flex><span>        - name: redis-data
</span></span><span style=display:flex><span>          persistentVolumeClaim:
</span></span><span style=display:flex><span>            claimName: openapi-redis-dev
</span></span><span style=display:flex><span>        - name: redis-conf
</span></span><span style=display:flex><span>          configMap:
</span></span><span style=display:flex><span>            defaultMode: 420
</span></span><span style=display:flex><span>            name: openapi-redis-dev-config
</span></span><span style=display:flex><span>  strategy:
</span></span><span style=display:flex><span>    type: RollingUpdate
</span></span><span style=display:flex><span>    rollingUpdate:
</span></span><span style=display:flex><span>      maxUnavailable: 1
</span></span><span style=display:flex><span>      maxSurge: 1
</span></span></code></pre></div></details><p>这里添加了注解<code>security.alpha.kubernetes.io/unsafe-sysctls: net.core.somaxconn=2000</code>，设置最大连接数为2000，同时还添加了<code>nodeSelector</code>和<code>tolerations</code>用于选择部署节点。</p><h2 id=修改redis配置>修改redis配置</h2><p>修改redis对应的configMap，将<code>tcp-backlog</code>设置为2000，再重新部署redis。再此进行压力测试，可以发现有效果。</p></article></div></main><div><h4 id=signature>Mon Aug 13, 2018
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/redis>redis</a></li><li><a href=https://number317.github.io/blog/tags/kubernetes>kubernetes</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/solved/firefox_open_markdown/>Firefox Open Markdown</a></li><li><a class=next href=https://number317.github.io/blog/solved/connection_reset_error/>Connection Reset Error</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>