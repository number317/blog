<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/solved/>solved</a></li><li class=active>»
<a href=https://number317.github.io/blog/solved/connection_reset_error/>Connection Reset Error</a></li></ul><div id=content><main id=main><h1>Connection Reset Error</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#问题排查>问题排查</a></li><li><a href=#原因查找>原因查找</a></li><li><a href=#问题解决>问题解决</a></li></ul></nav></aside><article id=content><h1 id=k8s-应用接口请求-connection-reset-错误>k8s 应用接口请求 connection reset 错误</h1><p>测试人员在进行压力测试时发现应用A的接口出现了 connection reset 的错误，出错率大概为十分之一，猜想可能是代码问题或是网络问题或是连接数限制问题。</p><h2 id=问题排查>问题排查</h2><p>应用A有三个环境，dev，uat和prod。其中dev和uat在同一集群中，因此网络环境相同，在代码上，三个环境都是一样的。</p><ul><li>测试prod环境的同一接口，并没有出现相同错误，说明代码没有问题。</li><li>如果是连接数限制问题，那么应该不止此次压测出现，而之前几次压测都没有出现改问题，所以暂时先排除。</li><li>验证网络问题，测试应用B的一个静态文件请求，也发现了相同的错误，现在基本可以确定是网络问题。</li></ul><h2 id=原因查找>原因查找</h2><p>要想排查网络问题，要先了解一下系统的网络架构。</p><p>首先最外面是一个A10负载均衡，80端口代理到k8s集群三个master节点的80端口，所有的域名都解析在这个A10上。</p><p>三台master节点的ip地址和80端口被用作集群中ingress controller的service的externalIP，域名通过ingress controller找到对应的应用。</p><p>网络问题需要一层一层排查，首先是应用本身。用循环来发送100次请求，查看应用日志：</p><div class="code-block code-block-container-indented"><pre><code id=code-d9bf8cf5b519491f31da51237508432a>for i in  {1..100}; do curl http://www.test.com/api/example; echo $i;done</code></pre><button class=copy-code-button onclick='copyCode("code-d9bf8cf5b519491f31da51237508432a",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>通过日志发现请求出现connection reset时，应用没有对应日志，说明请求没有到应用这里。</p><p>应用上一层是域名，域名是通过ingress来配置的，查看ingress controller的日志，发现也没有报错日志，所以请求也没有到这里。</p><p>接下来查看三台master节点的80端口，发现其中一台master1的80端口不通。看来问题应该就出现在这里了，我们可以手动来验证一下。</p><p>将要请求的域名映射为master2的ip地址，在<code>/etc/hosts</code>中加入<code>www.test.com master2IP</code>，进行测试，发现没有出现错误。改成master1的ip地址则发现无法连接。</p><h2 id=问题解决>问题解决</h2><p>查看了k8s集群的网络组件，发现master1上的flannel一直处于container creating状态。将pod删除重启，再次进行测试，发现connection reset的错误已经没了。</p></article></div></main><div><h4 id=signature>Fri Oct 19, 2018
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/k8s>k8s</a></li><li><a href=https://number317.github.io/blog/tags/network>network</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/solved/redis_somaxconn/>Redis Somaxconn</a></li><li><a class=next href=https://number317.github.io/blog/solved/ssh_config/>Ssh Config</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>