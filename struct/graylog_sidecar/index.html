<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/graylog_sidecar/>Graylog Sidecar</a></li></ul><div id=content><main id=main><h1>Graylog Sidecar</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#安装sidecar>安装sidecar</a></li><li><a href=#配置sidecar>配置sidecar</a></li><li><a href=#生存测试日志>生存测试日志</a></li><li><a href=#graylog-配置>graylog 配置</a></li><li><a href=#启动sidecar>启动sidecar</a></li><li><a href=#index-set-配置>index set 配置</a></li><li><a href=#stream-配置>stream 配置</a></li><li><a href=#pipeline-配置>pipeline 配置</a></li></ul></nav></aside><article id=content><h1 id=graylog-sidecar-部署配置>graylog sidecar 部署配置</h1><p>graylog sidecar 用于配置从文件读取日志，具体读取文件可以采用filebeat和nxlog。这里在debian的容器中部署sidecar来示例。</p><h2 id=安装sidecar>安装sidecar</h2><p>从<a href=https://github.com/Graylog2/collector-sidecar/releases>下载页面</a>下载对应的包，这里是debian系统，graylog版本是2.4。所以根据文档，下载<code>collector-sidecar_0.1.7-1_amd64.deb</code>：</p><div class="code-block code-block-container-indented"><pre><code id=code-0e2bc5b8c0291399e63a0940370f4c54>curl -OL &#34;https://github.com/Graylog2/collector-sidecar/releases/download/0.1.7/collector-sidecar_0.1.7-1_amd64.deb&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-0e2bc5b8c0291399e63a0940370f4c54",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>下载好后安装：</p><div class="code-block code-block-container-indented"><pre><code id=code-000bd49e39ed30b1c5a0457b05aca32e>dpkg -i collector-sidecar_0.1.7-1_amd64.deb</code></pre><button class=copy-code-button onclick='copyCode("code-000bd49e39ed30b1c5a0457b05aca32e",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>安装好后配置system服务：</p><div class="code-block code-block-container-indented"><pre><code id=code-280a7782acdc4aff590046950709e3c9>graylog-collector-sidecar -service install</code></pre><button class=copy-code-button onclick='copyCode("code-280a7782acdc4aff590046950709e3c9",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这个命令会生成<code>/etc/init.d/collector-sidecar</code>脚步，但是在容器中可能systemctl命令执行不了，可以直接执行该脚本。</p><h2 id=配置sidecar>配置sidecar</h2><p>编辑配置文件<code>/etc/graylog/collector-sidecar</code>，改为以下内容：</p><div class="code-block code-block-container-indented"><pre><code id=code-1b3d2131eb0dc8acdb078abe7cd29206>server_url: http://graylog.test.com/api/
update_interval: 10
tls_skip_verify: false
send_status: true
list_log_files:
    - /var/log/connect-check/
collector_id: file:/etc/graylog/collector-sidecar/collector-id
cache_path: /var/cache/graylog/collector-sidecar
log_path: /var/log/graylog/collector-sidecar
log_rotation_time: 86400
log_max_age: 604800
tags:
    - connect-check
backends:
    - name: nxlog
      enabled: false
      binary_path: /usr/bin/nxlog
      configuration_path: /etc/graylog/collector-sidecar/generated/nxlog.conf
    - name: filebeat
      enabled: true
      binary_path: /usr/bin/filebeat
      configuration_path: /etc/graylog/collector-sidecar/generated/filebeat.yml</code></pre><button class=copy-code-button onclick='copyCode("code-1b3d2131eb0dc8acdb078abe7cd29206",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>主要是修改<code>server_url</code>和<code>tags</code>两项内容。</p><h2 id=生存测试日志>生存测试日志</h2><p>编写一个脚本random.sh来生成一些测试日志：</p><div class="code-block code-block-container-indented"><pre><code id=code-e78b6335cadaf73eafa2cd859c0be601>#!/bin/bash
while true; do
    flag=$RANDOM
    if [[ $flag -le 10923 ]]; then
        echo &#34;Accept 200, connect checkout success.&#34; &gt;&gt; /var/log/connect-check/connect-check.log
    elif [[ $flag -gt 10923 &amp;&amp; $flag -le 20491 ]]; then
        echo -e &#34;Failed 500, connect checkout failed. Internal Error\n    Check out the code.&#34; &gt;&gt; /var/log/connect-check/connect-check.log
    else
        echo -e &#34;Failed 404, connect checkout failed. Connection Not Found\n    Maybe your url is incorrect.&#34; &gt;&gt; /var/log/connect-check/connect-check.log
    fi
    interval=$(( $RANDOM%10&#43;1 ))
    sleep ${interval}
done</code></pre><button class=copy-code-button onclick='copyCode("code-e78b6335cadaf73eafa2cd859c0be601",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这个脚本会生成多行的日志，用于测试graylog对于多行日志的支持。将脚本放后台执行，持续生成日志：</p><div class="code-block code-block-container-indented"><pre><code id=code-08791e62ac4c2fde3fd8a0740405b53b>nohup ./random.sh &amp;</code></pre><button class=copy-code-button onclick='copyCode("code-08791e62ac4c2fde3fd8a0740405b53b",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=graylog-配置>graylog 配置</h2><ol><li><p>在graylog界面上点击<code>System/Inputs</code>菜单，创建一个全局的<code>Beats</code>输入，配置监听地址<code>0.0.0.0</code>，监听端口<code>5004</code></p><p><img src=https://number317.github.io/blog/struct/images/graylog_sidecar_img1.png alt="global input"></p></li><li><p>进入<code>System/Collectors/Manage configurations</code> 菜单，创建一个新的配置，任意命名为<code>connect-check</code></p></li><li><p>点击刚刚创建的配置，创建一个<code>Filebeat</code>输出，暂时只需要修改<code>Hosts</code>的地址，修改为graylog服务器的ip（k8s集群里可以是service的地址）和端口（刚刚创建的全局Beats输入的监听端口）</p></li><li><p>创建一个<code>Filebeat</code>文件输入来收集刚刚脚本生成的测试日志，填写对应的日志路径，配置转发到刚刚创建的filebeat类型的输出。点击启用多行日志的支持，填写多行日志的开头正则表达式，这里是4个空格。在<code>Additional Fields</code>项可以配置额外的自定义字段，比如我们可以添加一个字段<code>app</code>，值为<code>connect-check</code></p></li><li><p>为配置添加一个<code>connect-check</code>的tag，在tag栏输入tag名，按回车键</p><p><img src=https://number317.github.io/blog/struct/images/graylog_sidecar_img2.png alt="configuration tag"></p></li></ol><h2 id=启动sidecar>启动sidecar</h2><p>执行<code>/etc/init.d/collector-sidecar start</code>来启动sidecar，它的日志在<code>/var/log</code>目录下，可以查看该目录下的<code>collector-sidecar.err</code>文件来检查sidecar的运行状态。</p><p>通过日志可以查看到它从graylog获取了新的配置，这个配置就是刚刚在graylog上创建的配置，他们是通过tag来匹配的。现在在graylog的search页面应该可以查看到生成的测试日志了。</p><h2 id=index-set-配置>index set 配置</h2><p>graylog默认的索引集只有一个<code>Default index set</code>，查看es的索引也可以看到只有一个<code>graylog_0</code>的索引。我们创建一个新的名为connect-check的索引集。</p><p>点击<code>system/indices</code>，点击<code>Create index set</code>，Title, Description, Index prefix都可以写connect-check。其他的选项暂时默认就好。这样就创建好了一个新的索引集。</p><p><img src=https://number317.github.io/blog/struct/images/graylog_sidecar_img3.png alt="index set"></p><h2 id=stream-配置>stream 配置</h2><p>graylog的stream可以实时地将信息转发到不同的分类当中。比如可以将日志级别为<code>error</code>的日志转发到一个名为error的stream中。我们创建一个名为connect-check的流，用于接收connect-check的日志。</p><p>点击<code>Stream/Create Stream</code>，填写Title和Description，Index Set 选择刚刚创建的connect-check。下面还有一个可选项<code>Remove matches from 'All messages' stream</code>，如果选择了这一选项，匹配的日志会从<code>All messages</code>流中删除。在connect-check流上点击<code>Manage Rules/Add stream rule</code>，<code>Field</code>填写在input里添加的自定义字段<code>app</code>，<code>Type</code>选择<code>match exactly</code>表示精确匹配，<code>value</code>填写<code>connect-check</code>，点击<code>Save</code>。这样只有connect-check的日志会到这个流里面。</p><p>现在点击<code>Start Stream</code>，这个流就被启用了。点击这个流可以看到对应的日志数据，但现在整个日志都在一个名为<code>message</code>的字段中。</p><h2 id=pipeline-配置>pipeline 配置</h2><p>graylog的pipeline可以灵活地配置日志的展现格式，它包含一系列规则，可以关联到多个流。</p><p>点击<code>System/pinpelines/Add new pipeline</code>，填写pipeline的名字描述。再点击<code>Manage rules/Create Rule</code>，添加描述，填写以下规则内容：</p><div class="code-block code-block-container-indented"><pre><code id=code-ed707316e00fee42fc5829f4043c50d3>rule &#34;function connect-check&#34;
when
    has_field(&#34;message&#34;)
then
    let message_field = to_string($message.message);
    let action = grok(pattern: &#34;(?&lt;result&gt;[A-Z][a-z]*) %{NUMBER:return_code}, (?&lt;info&gt;[\\s\\S]*)&#34;, value: message_field, only_named_captures: true);
    set_fields(action);
end</code></pre><button class=copy-code-button onclick='copyCode("code-ed707316e00fee42fc5829f4043c50d3",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p><img src=https://number317.github.io/blog/struct/images/graylog_sidecar_img4.png alt=rules></p><p>这个规则规定了如果找到有<code>message</code>字段，就根据正则匹配把<code>message</code>字段拆分为<code>result</code>, <code>return_code</code>, <code>info</code>三个字段。</p><p>其中的正则匹配可以先在<a href=https://grokdebug.herokuapp.com>grokdebug</a>(网站可能需要翻墙)先测试通过再应用到rule中。</p><p>点击刚刚创建的pipeline，点击<code>Add new stage</code>，选择刚刚创建的rules，保存，这样一个pipeline就创建好了。</p><p>点击stream，选择connect-check流，可以看到左边导航栏列出了许多日志信息的字段，点击<code>Fields</code>旁边的Decorators，选择<code>Pipeline Processor Decorator</code>，选择刚刚创建的pipeline，就可以在左边的字段中看到有<code>result</code>, <code>return_code</code>, <code>info</code>三个字段了。这样可以灵活地搜索以及制定告警规则。</p><p><img src=https://number317.github.io/blog/struct/images/graylog_sidecar_img5.png alt=decorators></p></article></div></main><div><h4 id=signature>Wed Nov 14, 2018
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/log>log</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/graylog_k8s_install/>Graylog K8s Install</a></li><li><a class=next href=https://number317.github.io/blog/struct/skywalking_deploy/>Skywalking Deploy</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>