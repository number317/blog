<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/k8s_cluster_deploy/>K8s Cluster Deploy</a></li></ul><div id=content><main id=main><h1>K8s Cluster Deploy</h1><time>Last updated Tue Dec 17, 2024</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#集群说明>集群说明</a></li><li><a href=#vagrant-配置>vagrant 配置</a></li></ul></nav></aside><article id=content><h1 id=vagrant-kubernetes-集群部署>vagrant kubernetes 集群部署</h1><h2 id=集群说明>集群说明</h2><p>集群共有四个节点，一个master节点，四个子节点，其中一个节点即是master节点，也是node节点，系统均为centos-7.2。</p><div class="code-block code-block-container-indented"><pre><code id=code-65b9cc52d4025169e1ab47cc4ac119d3>k8s-node1      192.168.12.81       master, node
k8s-node2      192.168.12.82       node
k8s-node3      192.168.12.83       node
k8s-node4      192.168.12.84       node</code></pre><button class=copy-code-button onclick='copyCode("code-65b9cc52d4025169e1ab47cc4ac119d3",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=vagrant-配置>vagrant 配置</h2><p>vagrant 的 box 可选用 bento/centos-7.2:</p><details><summary>Vagrantfile</summary><div class="code-block code-block-container-indented"><pre><code id=code-788a0ef8ab46f096ec685e5aacee50b7># -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The &#34;2&#34; in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don&#39;t change it unless you know what
# you&#39;re doing.
Vagrant.configure(&#34;2&#34;) do |config|
    (1..4).each do |i|
        config.vm.define &#34;k8s-node#{i}&#34; do |node|
            file_to_disk = &#34;tmp/k8s_node#{i}_disk.vdi&#34;
            node.vm.box = &#34;centos-7.2&#34;
            node.vm.hostname = &#34;k8s-node#{i}&#34;
            n = 80 &#43;i
            node.vm.network &#34;private_network&#34;, ip: &#34;192.168.12.#{n}&#34;
            node.vm.provider &#34;virtualbox&#34; do |vb|
                vb.name = &#34;k8s-node#{i}&#34;
                vb.cpus = 2
                vb.memory = 1024
            end
            node.vm.provision &#34;ansible&#34; do |ansible|
                ansible.playbook = &#34;playbook.yml&#34;
                ansible.groups = {
                &#34;master&#34; =&gt; [&#34;k8s-node1&#34;],
                &#34;nodes&#34; =&gt; (1..4).map {|j| &#34;k8s-node#{j}&#34;},
            }
            end
        end
    end
end</code></pre><button class=copy-code-button onclick='copyCode("code-788a0ef8ab46f096ec685e5aacee50b7",this)' title=copy>
<i class="fa fa-copy"></i></button></div></details><p>其中的 playbook.yml 主要用于一些软件的安装和简单的配置，内容如下：</p><details><summary>playbook</summary><div class="code-block code-block-container-indented"><pre><code id=code-337ca3d80b70aa325da33946237df4c4>---
- hosts: all
  tasks:
    - name: install epel-release
      yum:
        name: epel-release
        state: latest
      become: true
    - name: stop &amp; disable firewall
      shell: systemctl stop firewalld &amp;&amp; systemctl disable firewalld
      become: true
- hosts: master
  tasks:
    - name: master install softwares
      yum:
        name={{item}}
        state=latest
      with_items:
        - etcd
        - kubernetes-master
      become: true
- hosts: nodes
  tasks:
    - name: nodes install softwares
      yum:
        name={{item}}
        state=latest
      with_items:
        - vim
        - bash-completion
        - docker
        - flannel
        - kubernetes-node
      become: true</code></pre><button class=copy-code-button onclick='copyCode("code-337ca3d80b70aa325da33946237df4c4",this)' title=copy>
<i class="fa fa-copy"></i></button></div></details><p>上面的 playbook 定义了一些任务，分别是关闭了所有虚拟机的防火墙；在 master 节点上安装了 etcd，kubernetes-master 等软件；在 node 节点上安装了 vim，bash-completion，docker，flannel，kubernetes-node 等软件。运行<code>vagrant up</code>启动定义好的四个虚拟机。</p><h1 id=master-节点配置>master 节点配置</h1><p>执行<code>vagrant ssh k8s-node1</code>登录到 master 节点上，执行<code>sudo su</code>切换到 root 用户</p><ol><li><p>编辑<code>/etc/etcd/etcd.conf</code>文件:</p><div class="code-block code-block-container-indented"><pre><code id=code-7d4f5cd02d59a9950df7a1e0b75b5859>ETCD_NAME=master
ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
ETCD_LISTEN_CLIENT_URLS=&#34;http://0.0.0.0:2379&#34;
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.12.81:2379&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-7d4f5cd02d59a9950df7a1e0b75b5859",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>编辑<code>/etc/kubernetes/apiserver</code>文件:</p><div class="code-block code-block-container-indented"><pre><code id=code-311a821188f07beadaebd4ac3b553999>KUBE_API_ADDRESS=&#34;--insecure-bind-address=0.0.0.0&#34;
KUBE_API_PORT=&#34;--port=8080&#34;
KUBELET_PORT=&#34;--kubelet-port=10250&#34;
KUBE_ETCD_SERVERS=&#34;--etcd-servers=http://127.0.0.1:2379&#34;
KUBE_SERVICE_ADDRESSES=&#34;--service-cluster-ip-range=10.254.0.0/16&#34;
KUBE_ADMISSION_CONTROL=&#34;--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota&#34;
KUBE_API_ARGS=&#34;&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-311a821188f07beadaebd4ac3b553999",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>启动 etcd、kube-apiserver、kube-controller-manager、kube-scheduler、docker 等服务，并设置开机启动。</p><div class="code-block code-block-container-indented"><pre><code id=code-fe4891dd8a6b468e4d21159ab568afce>for service in etcd kube-apiserver kube-controller-manager kube-scheduler docker; do systemctl restart $service;systemctl enable $service;systemctl status $service ; done</code></pre><button class=copy-code-button onclick='copyCode("code-fe4891dd8a6b468e4d21159ab568afce",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li></ol><h1 id=node-节点配置>node 节点配置</h1><p>登录到各个 node 节点上（包括即作为 master 也作为 node 的 k8s-node1 节点），执行以下操作。</p><ol><li><p>为 flannel 网络指定 etcd 服务，修改<code>/etc/sysconfig/flanneld</code>文件:</p><div class="code-block code-block-container-indented"><pre><code id=code-98e0713b8c8fe228e7b32da64075895b>FLANNEL_ETCD=&#34;http://192.168.12.81:2379&#34;
FLANNEL_ETCD_KEY=&#34;/atomic.io/network&#34;
FLANNEL_OPTIONS=&#34;--iface=enp0s8&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-98e0713b8c8fe228e7b32da64075895b",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>etcd和flannel用于配置容器的跨主机通信，具体见<a href=./struct/etcd--flannel/>etcd & flannel</a></p></li><li><p>修改<code>/etc/kubernetes/config</code>文件:</p><div class="code-block code-block-container-indented"><pre><code id=code-68c9fe85d5c3016b6a0e0d9e338cda87>KUBE_LOGTOSTDERR=&#34;--logtostderr=true&#34;
KUBE_LOG_LEVEL=&#34;--v=0&#34;
KUBE_ALLOW_PRIV=&#34;--allow-privileged=false&#34;
KUBE_MASTER=&#34;--master=http://192.168.12.81:8080&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-68c9fe85d5c3016b6a0e0d9e338cda87",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>修改kubelet配置文件<code>/etc/kubernetes/kubelet</code>:</p><div class="code-block code-block-container-indented"><pre><code id=code-b1a060ea6c7c60d4b5a7f452a1570c7e>KUBELET_ADDRESS=&#34;--address=0.0.0.0&#34;
KUBELET_PORT=&#34;--port=10250&#34;
#这里的KUBELET_HOSTNAME是该node的ip地址
KUBELET_HOSTNAME=&#34;--hostname-override=192.168.12.82&#34;
KUBELET_API_SERVER=&#34;--api-servers=http://192.168.12.81:8080&#34;
KUBELET_POD_INFRA_CONTAINER=&#34;--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/architect/pod-infrastructure&#34;
KUBELET_ARGS=&#34;&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-b1a060ea6c7c60d4b5a7f452a1570c7e",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这里的<code>KUBELET_POD_INFRA_CONTAINER</code>默认的镜像需要翻墙，这里改成了阿里云的镜像，便于下载。</p></li><li><p>在所有 Node节点上启动 kube-proxy,kubelet,docker,flanneld 等服务，并设置开机启动。</p><div class="code-block code-block-container-indented"><pre><code id=code-481987aebe07d2f5cb8824ba9361b3c6>for service in kube-proxy kubelet docker flanneld;do systemctl restart $service;systemctl enable $service;systemctl status $service; done</code></pre><button class=copy-code-button onclick='copyCode("code-481987aebe07d2f5cb8824ba9361b3c6",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li></ol><h1 id=查看集群状态>查看集群状态</h1><p>在master节点 k8s-node1 上执行<code>kubectl get nodes</code>:</p><div class="code-block code-block-container-indented"><pre><code id=code-7dc7e20b1358fcf4c8fceae7c212f041>kubectl get nodes
NAME            STATUS    AGE
192.168.12.81   Ready     22h
192.168.12.82   Ready     22h
192.168.12.83   Ready     22h
192.168.12.84   Ready     22h</code></pre><button class=copy-code-button onclick='copyCode("code-7dc7e20b1358fcf4c8fceae7c212f041",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>看到节点的状态是 ready 说明集群已经搭建成功。</p><h1 id=配置dashboard>配置dashboard</h1><p>部署文件 dashboard.yml 如下：</p><details><summary>dashboard deploy</summary><div class="code-block code-block-container-indented"><pre><code id=code-5d75fbd748280a29dc9882d1a40739b3>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kubernetes-dashboard-v1.7.1
  namespace: kube-system
spec:
  replicas: 1
  template:
    metadata:
      labels:
        k8s-app: kubernetes-dashboard
        version: v1.7.1
        kubernetes.io/cluster-service: &#34;true&#34;
    spec:
      containers:
      - name: kubernetes-dashboard
        image: registry.cn-hangzhou.aliyuncs.com/google-containers/kubernetes-dashboard-amd64
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
          requests:
            cpu: 100m
            memory: 50Mi
        ports:
        - containerPort: 9090
        args:
         -  --apiserver-host=http://192.168.12.81:8080
        livenessProbe:
          httpGet:
            path: /
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
  labels:
    k8s-app: kubernetes-dashboard
    kubernetes.io/cluster-service: &#34;true&#34;
spec:
  selector:
    k8s-app: kubernetes-dashboard
  ports:
  - port: 80
    targetPort: 9090</code></pre><button class=copy-code-button onclick='copyCode("code-5d75fbd748280a29dc9882d1a40739b3",this)' title=copy>
<i class="fa fa-copy"></i></button></div></details><p>在master节点192.168.12.81上执行</p><div class="code-block code-block-container-indented"><pre><code id=code-dc3cbe9742936b88d825922d506139d6>kubectl apply -f dashboard.yml</code></pre><button class=copy-code-button onclick='copyCode("code-dc3cbe9742936b88d825922d506139d6",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>等待 pod 部署好后，访问<code>192.168.12.81:8080/ui</code>即可看到 dashboard 的界面。</p></article></div></main><div><h4 id=signature>Mon Dec 4, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/k8s>k8s</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/maven_nexus/>Maven & Nexus</a></li><li><a class=next href=https://number317.github.io/blog/struct/fluentd_config/>Fluentd Config</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>