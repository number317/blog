<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/rabbitmq_publish_subscribe/>Rabbitmq Publish Subscribe</a></li></ul><div id=content><main id=main><h1>Rabbitmq Publish Subscribe</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#交换exchanges>交换(Exchanges)</a></li><li><a href=#查看交换>查看交换</a></li><li><a href=#临时队列>临时队列</a></li><li><a href=#绑定bindings>绑定（Bindings）</a></li><li><a href=#列出绑定>列出绑定</a></li></ul></nav></aside><article id=content><h1 id=publish-subcribe>Publish Subcribe</h1><p>发布和订阅模式简单而言就是将一个消息发送个多个消费者。为了阐明这个模式，这里将会构建一个简单的日志系统，这个系统由两部分组成，第一个程序发送消息，第二个程序接收和打印消息。</p><p>在该日志系统中，接收程序的每一个运行副本都将得到消息，这样我们可以运行一个接收器，并将日志存放在磁盘；同时运行另一个接收器将日志在屏幕上打印出来。</p><h2 id=交换exchanges>交换(Exchanges)</h2><p>rabbitmq 消息模型的核心是生产者从不直接发送任何消息到队列。事实上，一个生产者经常不知道一个消息是否被发送到了队列。生产者只能将消息发送给交换。交换是一个非常简单的东西，它一边接收来自生产者的消息，另一边它把消息推入消息队列。交换是一定知道要怎么处理它接收到的消息的。应该被追加到一个特定的队列后，还是应该追加到多个队列中，还是应该被丢弃。这些规则都由交换类型（exchange type）定义。</p><p><img src=https://number317.github.io/blog/struct/images/rabbitmq_publish_subscribe_img1.png alt=exchange></p><p>有一些可用的交换类型：<code>direct</code>, <code>topic</code>, <code>headers</code> 和 <code>fanout</code>，这里将使用最后一个类型&ndash;<code>fanout</code>。创建一个名为<code>logs</code>的该类型交换：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>channel.exchange_declare(exchange=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>, exchange_type=<span style=color:#666;font-style:italic>&#39;fanout&#39;</span>)
</span></span></code></pre></div><p><code>fanout</code>类型的交换非常简单。就如它的名字一样，它只是将它接收到的信息广播到它知道的所有队列，这正是我们日志系统所需要的。</p><h2 id=查看交换>查看交换</h2><p>列出服务器上可用的交换可以使用<code>rabbitmqctl</code>命令:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rabbitmqctl list_exchanges
</span></span></code></pre></div><p>在列表中会有一些<code>amq.*</code>的交换和默认（未命名）的交换。这些是默认配置的，但是这里目前用不到他们。</p><p>有时候我们通过空字符串<code>''</code>来使用默认的交换：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>channel.basic_publish(exchange=<span style=color:#666;font-style:italic>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                      routing_key=<span style=color:#666;font-style:italic>&#39;hello&#39;</span>,
</span></span><span style=display:flex><span>                      body=message)
</span></span></code></pre></div><p>现在我们可以推送到我们的命名交换中：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>channel.basic_publish(
</span></span><span style=display:flex><span>    <span style=color:#666;font-weight:700;font-style:italic>exchange</span>=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#666;font-weight:700;font-style:italic>routing_key</span>=<span style=color:#666;font-style:italic>&#39;&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#666;font-weight:700;font-style:italic>body</span>=message
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><h2 id=临时队列>临时队列</h2><p>有时我们使用的队列有指定的名字，能够为队列命名是至关重要的，我们需要指定工作到相同的队列。当你想要在生产者和消费者间共享队列时为队列命名是很重要的。但是在我们的日志系统中，我们想要监听所有的日志，而不是一些；我们也只对当前流动的信息感兴趣而不是旧的信息。要达到这个效果我们需要两件事。</p><p>第一，无论何时连接到rabbitmq我们需要刷新，清空队列。为了做到这个我们可以用随机名字创建一个队列，或者更好的是让服务器为我们选择一个随机的队列名字。可以通过不给<code>queue</code>参数到<code>queue_declare</code>来做到这一点：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>result = channel.queue_declare()
</span></span></code></pre></div><p>这个时候<code>result.method.queue</code>包含了一个随机的队列名。例如它可能看起来像<code>amq.gen-JzTY20BRgKO-HjmUJj0wLg</code></p><p>第二，一旦消费者连接被关闭，队列应该被删除，有一个<code>exclusive</code>标签：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>result</span> = channel.queue_declare(<span style=color:#666;font-weight:700;font-style:italic>excusive</span>=True)
</span></span></code></pre></div><p>可以在<a href=http://www.rabbitmq.com/queues.html>队列指南</a>获取更多<code>exclusive</code>标签和其他队列属性。</p><h2 id=绑定bindings>绑定（Bindings）</h2><p><img src=https://number317.github.io/blog/struct/images/rabbitmq_publish_subscribe_img2.png alt=绑定></p><p>我们已经创建了一个<code>fanout</code>类型的交换。现在我们需要告诉交换发送信息给我们的队列。交换和队列之间的关系叫做绑定：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>channel.queue_bind(exchange=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>, queue=result.method.queue)
</span></span></code></pre></div><p>现在<code>logs</code>交换将会追加信息到我们的队列。</p><h2 id=列出绑定>列出绑定</h2><p>可以列出当前存在的绑定：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rabbitmqctl list_bindings
</span></span></code></pre></div><p>最终代码如下</p><p>生产者<code>emit_log.py</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#888;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#666;font-weight:700;font-style:italic>pika</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#666;font-weight:700;font-style:italic>sys</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>connection = pika.BlockingConnection(pika.ConnectionParameters(<span style=color:#666;font-style:italic>&#39;172.17.0.6&#39;</span>, 5672, credentials=pika.PlainCredentials(<span style=color:#666;font-style:italic>&#39;guest&#39;</span>, <span style=color:#666;font-style:italic>&#39;guest&#39;</span>)))
</span></span><span style=display:flex><span>channel = connection.channel()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel.exchange_declare(exchange=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>,
</span></span><span style=display:flex><span>                         exchange_type=<span style=color:#666;font-style:italic>&#39;fanout&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>message = <span style=color:#666;font-style:italic>&#39; &#39;</span>.join(sys.argv[1:]) <span style=font-weight:700>or</span> <span style=color:#666;font-style:italic>&#34;info: Hello World!&#34;</span>
</span></span><span style=display:flex><span>channel.basic_publish(exchange=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>,
</span></span><span style=display:flex><span>                      routing_key=<span style=color:#666;font-style:italic>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                      body=message)
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>print</span>(<span style=color:#666;font-style:italic>&#34; [x] Sent </span><span style=color:#666;font-style:italic>%r</span><span style=color:#666;font-style:italic>&#34;</span> % message)
</span></span><span style=display:flex><span>connection.close()
</span></span></code></pre></div><p>消费者<code>receive_logs.py</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#888;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#666;font-weight:700;font-style:italic>pika</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>connection = pika.BlockingConnection(pika.ConnectionParameters(<span style=color:#666;font-style:italic>&#39;172.17.0.6&#39;</span>, 5672, credentials=pika.PlainCredentials(<span style=color:#666;font-style:italic>&#39;guest&#39;</span>, <span style=color:#666;font-style:italic>&#39;guest&#39;</span>)))
</span></span><span style=display:flex><span>channel = connection.channel()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel.exchange_declare(exchange=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>,
</span></span><span style=display:flex><span>                         exchange_type=<span style=color:#666;font-style:italic>&#39;fanout&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>result = channel.queue_declare(exclusive=<span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>queue_name = result.method.queue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel.queue_bind(exchange=<span style=color:#666;font-style:italic>&#39;logs&#39;</span>,
</span></span><span style=display:flex><span>                   queue=queue_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>print</span>(<span style=color:#666;font-style:italic>&#39; [*] Waiting for logs. To exit press CTRL+C&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#666;font-weight:700;font-style:italic>callback</span>(ch, method, properties, body):
</span></span><span style=display:flex><span>    <span style=font-weight:700;font-style:italic>print</span>(<span style=color:#666;font-style:italic>&#34; [x] </span><span style=color:#666;font-style:italic>%r</span><span style=color:#666;font-style:italic>&#34;</span> % body)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel.basic_consume(callback,
</span></span><span style=display:flex><span>                      queue=queue_name,
</span></span><span style=display:flex><span>                      no_ack=<span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>channel.start_consuming()
</span></span></code></pre></div><p>如果想要保存日志到文件，只要运行如下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./receive_logs.py &gt; logs_from_rabbit.log
</span></span></code></pre></div><p>如果想要在终端上产看日志，秩序运行：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./receive_logs.py
</span></span></code></pre></div><p>发送日志：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python emit_log.py
</span></span></code></pre></div></article></div></main><div><h4 id=signature>Fri Oct 27, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/rabbitmq>rabbitmq</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/rabbitmq_work_queue/>Rabbitmq Work Queue</a></li><li><a class=next href=https://number317.github.io/blog/struct/rabbitmq_routing/>Rabbitmq Routing</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>