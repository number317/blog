<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/emqx_backend_mysql/>Emqx Backend Mysql</a></li></ul><div id=content><main id=main><h1>Emqx Backend Mysql</h1><time>Last updated Thu Oct 15, 2020</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#erlang-环境配置>erlang 环境配置</a></li><li><a href=#emacs-编辑器配置>emacs 编辑器配置</a></li><li><a href=#emqx-源码编译>emqx 源码编译</a></li><li><a href=#添加自定义插件>添加自定义插件</a></li><li><a href=#启用自定义插件>启用自定义插件</a></li><li><a href=#反编译-emqx_backend_mysql-插件>反编译 <code>emqx_backend_mysql</code> 插件</a></li><li><a href=#构造插件>构造插件</a></li><li><a href=#搭建临时-git-服务>搭建临时 git 服务</a></li><li><a href=#重新编译>重新编译</a></li><li><a href=#测试插件>测试插件</a></li><li><a href=#构建镜像>构建镜像</a></li></ul></nav></aside><article id=content><ul><li><a href=#orgc3804b0>emqx mysql 插件</a><ul><li><a href=#org5864efb>erlang 环境配置</a></li><li><a href=#orgeb79a2a>emacs 编辑器配置</a></li><li><a href=#org0232e02>emqx 源码编译</a></li><li><a href=#org63abe84>添加自定义插件</a></li><li><a href=#org91c1187>启用自定义插件</a></li><li><a href=#org8c85d4f>反编译 <code>emqx_backend_mysql</code> 插件</a></li><li><a href=#org4dafec4>构造插件</a></li><li><a href=#orgaadf956>搭建临时 git 服务</a></li><li><a href=#org2054d0d>重新编译</a></li><li><a href=#org773634b>测试插件</a></li><li><a href=#org314e5bf>构建镜像</a></li></ul></li></ul><p><a id=orgc3804b0></a></p><h1 id=emqx-mysql-插件>emqx mysql 插件</h1><p><a id=org5864efb></a></p><h2 id=erlang-环境配置>erlang 环境配置</h2><p>erlang 推荐使用 22 版本，经过测试用 23 版本编译出来运行有问题。各平台安装 erlang 详情请参考官方文档。 linux 系统可以使用 kerl 脚本安装，构建最新版本的 emqx 时注意编译的 gcc 版本不能用 10，编译通不过，推荐用 gcc-9</p><p>下载 kerl</p><div class="code-block code-block-container-indented"><pre><code id=code-a57440808827080a0e0e51f851f0bc3f>curl -O https://raw.githubusercontent.com/kerl/kerl/master/kerl
chmod &#43;x kerl</code></pre><button class=copy-code-button onclick='copyCode("code-a57440808827080a0e0e51f851f0bc3f",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>安装 erlang</p><div class="code-block code-block-container-indented"><pre><code id=code-b30d2fd5d28dc372555154c4eca82504>kerl update releases
# 如果直接构建报错，修改 ~/.kerl/builds/22.3/otp_src_22.3/Makefile
# 将 gcc 改为 gcc9
kerl build 22.3 22.3
kerl install 22.3 /opt/erlang/22.3
# 启用环境
source /opt/erlang/22.3/activate
# 设置环境变量，这样不用每次手动启用
echo &#39;source /opt/erlang/22.3/activate&#39; &gt;&gt; ~/.bashrc</code></pre><button class=copy-code-button onclick='copyCode("code-b30d2fd5d28dc372555154c4eca82504",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>安装 rebar3</p><div class="code-block code-block-container-indented"><pre><code id=code-f934f529ed22cf3999709b4f480379f8>curl -OL https://s3.amazonaws.com/rebar3/rebar3
./rebar3 local install
# 然后根据输出操作</code></pre><button class=copy-code-button onclick='copyCode("code-f934f529ed22cf3999709b4f480379f8",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p><a id=orgeb79a2a></a></p><h2 id=emacs-编辑器配置>emacs 编辑器配置</h2><p>需要安装 erlang 包，提供 erlang-mode 再安装 erlang-lsp</p><div class="code-block code-block-container-indented"><pre><code id=code-c92d10e2921e2f6946530eb0e3269a60>git clone https://github.com/erlang-ls/erlang_ls.git
cd erlang_ls &amp;&amp; make</code></pre><button class=copy-code-button onclick='copyCode("code-c92d10e2921e2f6946530eb0e3269a60",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p><a id=org0232e02></a></p><h2 id=emqx-源码编译>emqx 源码编译</h2><p>先克隆仓库，由于我们使用 v4.1.2 版本，所以切换到改 tag</p><div class="code-block code-block-container-indented"><pre><code id=code-f8006632cd30e17aa1677af8d5d5244a>git clone https://github.com/emqx/emqx-rel.git
cd emqx-rel
git checkout v4.1.2
make</code></pre><button class=copy-code-button onclick='copyCode("code-f8006632cd30e17aa1677af8d5d5244a",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>正常构建成功后，运行 <code>_build/emqx/rel/emqx/bin/emqx console</code> 启动 emqx</p><p><a id=org63abe84></a></p><h2 id=添加自定义插件>添加自定义插件</h2><p>修改 <code>rebar.config</code></p><div class="code-block code-block-container-indented"><pre><code id=code-aa8c3b6922a0c44dc4653223f597733a>  {deps,
     [ {buildrun_emqx_backend_mysql, {git, &#34;https://github.com/goBuildRun/buildrun-emqx-backend-mysql.git&#34;, {branch, &#34;master&#34;}}}
     , ....
     ....
     ]
  }
  ...
{relx,
    [...
    , ...
    , {release, {emqx, git_describe},
       [
         {buildrun_emqx_backend_mysql, load},
       ]
      }
    ]
}</code></pre><button class=copy-code-button onclick='copyCode("code-aa8c3b6922a0c44dc4653223f597733a",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p><img src=http://minio.gobuildrun.com/knowledgebase-service/13f84bdb-772d-4350-8d29-be96431ce5ae/blob.png alt=img></p><p>修改完成后重新编译，打开 <code>localhost:18083</code> 的插件栏可以看到 <code>buildrun_emqx_backend_mysql</code> 插件。</p><p><a id=org91c1187></a></p><h2 id=启用自定义插件>启用自定义插件</h2><p>执行以下 shell 脚本可以启动 mysql 容器</p><div class="code-block code-block-container-indented"><pre><code id=code-b5361277f14ceadb2e9d893227d474b2>#!/bin/bash
init_dir(){
    docker run -d -e MYSQL_ROOT_PASSWORD=&#34;1qaz!QAZ&#34; --name mysql_temp mysql:5.7
    docker cp mysql_temp:/etc/mysql/mysql.conf.d $PWD/
    mv $PWD/mysql.conf.d $PWD/mysql_conf
    docker cp mysql_temp:/var/lib/mysql $PWD/
    mv $PWD/mysql $PWD/mysql_data
    docker stop mysql_temp &amp;&amp; docker rm mysql_temp
}

main(){
    if [[ ! -d mysql_conf || ! -d mysql_data ]]; then
        init_dir
    fi
    docker run -d \
        -p 3306:3306 \
        -e MYSQL_ROOT_PASSWORD=&#34;1qaz!QAZ&#34; \
        -v $PWD/mysql_conf:/etc/mysql/conf.d:rw \
        -v $PWD/mysql_data:/var/lib/mysql:rw \
        --name mysql \
        mysql:5.7
}

main</code></pre><button class=copy-code-button onclick='copyCode("code-b5361277f14ceadb2e9d893227d474b2",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>mysql 启动后执行以下 sql</p><div class="code-block code-block-container-indented"><pre><code id=code-75f8df23a89e624cb8fa15d76598037a>CREATE DATABASE MQTT;
USE MQTT;

DROP TABLE IF EXISTS `mqtt_client`;
CREATE TABLE `mqtt_client` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `clientid` varchar(64) DEFAULT NULL,
  `state` varchar(3) DEFAULT NULL,
  `node` varchar(100) DEFAULT NULL,
  `online_at` datetime DEFAULT NULL,
  `offline_at` datetime DEFAULT NULL,
  `created` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `mqtt_client_idx` (`clientid`),
  UNIQUE KEY `mqtt_client_key` (`clientid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `mqtt_retain`;
CREATE TABLE `mqtt_retain` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `topic` varchar(200) DEFAULT NULL,
  `msgid` varchar(60) DEFAULT NULL,
  `sender` varchar(100) DEFAULT NULL,
  `node` varchar(100) DEFAULT NULL,
  `qos` int(2) DEFAULT NULL,
  `payload` blob,
  `arrived` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `mqtt_retain_key` (`topic`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `mqtt_acked`;
CREATE TABLE `mqtt_acked` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `clientid` varchar(200) DEFAULT NULL,
  `topic` varchar(200) DEFAULT NULL,
  `mid` int(200) DEFAULT NULL,
  `created` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `mqtt_acked_key` (`clientid`,`topic`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `mqtt_msg`;
CREATE TABLE `mqtt_msg` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `msgid` varchar(100) DEFAULT NULL,
  `topic` varchar(1024) DEFAULT NULL,
  `sender` varchar(1024) DEFAULT NULL,
  `node` varchar(60) DEFAULT NULL,
  `qos` int(11)  DEFAULT &#39;0&#39;,
  `retain` tinyint(2) DEFAULT NULL,
  `payload` blob,
  `arrived` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `mqtt_sub`;
CREATE TABLE `mqtt_sub` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `clientid` varchar(64) DEFAULT NULL,
  `topic` varchar(255) DEFAULT NULL,
  `qos` int(3) DEFAULT NULL,
  `created` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `mqtt_sub_idx` (`clientid`,`topic`(255),`qos`),
  UNIQUE KEY `mqtt_sub_key` (`clientid`,`topic`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;</code></pre><button class=copy-code-button onclick='copyCode("code-75f8df23a89e624cb8fa15d76598037a",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>修改插件配置文件 <code>_build/emqx/rel/emqx/etc/plugins/buildrun_emqx_backend_mysql.conf</code></p><div class="code-block code-block-container-indented"><pre><code id=code-51b06d7e6a4448602bb4181662629887>##====================================================================
## MySQL Backend for EMQ 3.0
##====================================================================

## MySQL Server
backend.mysql.server = 172.17.0.2:3306

## MySQL Pool Size
backend.mysql.pool_size = 8
## MySQL Username
backend.mysql.user = root
## MySQL Password
backend.mysql.password = 1qaz!QAZ
## MySQL Database
backend.mysql.database = mqtt

## MySQL Query Timeout
backend.mysql.query_timeout = 10s</code></pre><button class=copy-code-button onclick='copyCode("code-51b06d7e6a4448602bb4181662629887",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>在 dashboard 插件栏点击启用 <code>buildrun_emqx_backend_mysql</code> 即可启用成功</p><p><img src=http://minio.gobuildrun.com/knowledgebase-service/f0c50f8a-a34e-4a3d-a53b-0415ddf9d2a5/blob.png alt=img></p><p><a id=org8c85d4f></a></p><h2 id=反编译-emqx_backend_mysql-插件>反编译 <code>emqx_backend_mysql</code> 插件</h2><p><code>emqx_backend_mysql</code> 插件只有在企业版的 <code>emqx</code> 中才有，而且不开源，但经过测试发现可以反编译该插件来获取源代码 首先获取 <code>emqx-ee</code> 版本，从 docker 容器中获取编译后的插件</p><div class="code-block code-block-container-indented"><pre><code id=code-7541eb0f35541ecf488bc98442b78fac>docker pull emqx/emqx-ee:4.1.1-alpine-amd64
docker run -it --name emqx-ee --rm emqx/emqx-ee:4.1.1-alpine-amd64 sh</code></pre><button class=copy-code-button onclick='copyCode("code-7541eb0f35541ecf488bc98442b78fac",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>新开终端从容器复制插件</p><div class="code-block code-block-container-indented"><pre><code id=code-8d295b10e110b76fdb859f50eadd540c>docker cp emqx-ee:/opt/emqx ./emqx</code></pre><button class=copy-code-button onclick='copyCode("code-8d295b10e110b76fdb859f50eadd540c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>编写反编译脚本 <code>erl-decompile</code></p><div class="code-block code-block-container-indented"><pre><code id=code-f68f9d41373e77611c8617489bc8f3a6>#!/usr/bin/env escript

main(BeamFile) -&gt;
    [FileName | _] = string:split(BeamFile, &#34;.&#34;),
    SourceFile = string:concat(FileName, &#34;.erl&#34;),
    {ok, Fd} = file:open(SourceFile, [write]),
    {ok,{_,[{abstract_code,{_,AC}}]}} = beam_lib:chunks(FileName,[abstract_code]),
    io:fwrite(Fd, &#34;~s~n&#34;, [erl_prettypr:format(erl_syntax:form_list(AC))]).</code></pre><button class=copy-code-button onclick='copyCode("code-f68f9d41373e77611c8617489bc8f3a6",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>将脚本放到可执行目录，在 <code>emqx_backend_mysql-4.1.1/ebin</code> 目录下进行反编译</p><div class="code-block code-block-container-indented"><pre><code id=code-03bcddf6f8eaead48e3b1e3ea5346661>for f in *.beam; do erl-decompile $f; done</code></pre><button class=copy-code-button onclick='copyCode("code-03bcddf6f8eaead48e3b1e3ea5346661",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>执行成功后会生成 erl 源文件</p><p><a id=org4dafec4></a></p><h2 id=构造插件>构造插件</h2><p>克隆插件模板，并重命名</p><div class="code-block code-block-container-indented"><pre><code id=code-6b06c018ca6fda6e04a5c1e52a490089>https://github.com/emqx/emqx-plugin-template.git
mv emqx-plugin-template emqx_backend_mysql</code></pre><button class=copy-code-button onclick='copyCode("code-6b06c018ca6fda6e04a5c1e52a490089",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>将 <code>emqx_backend_mysql/src</code> 下的 <code>erl</code> 模板文件删除 将反编译出来的 <code>erl</code> 源文件复制到 <code>emqx_backend_mysql/src</code> 目录下，将原来 <code>ebin</code> 目录下的 <code>emqx_backend_mysql.app</code> 文件也一起复制过来 将 <code>emqx_backend_mysql/src</code> 目录下的 <code>emqx_plugin_template.app.src</code> 和 <code>emqx_plugin_template.app.src.script</code> 重命名</p><div class="code-block code-block-container-indented"><pre><code id=code-811b1ce65ac5d60dd553140c261759fd>rm *.erl
cp path/to/ebin/*.erl ./
mv emqx_plugin_tempate.app.src emqx_backend_mysql.app.src
mv emqx_plugin_tempate.app.src.script emqx_backend_mysql.app.src.script</code></pre><button class=copy-code-button onclick='copyCode("code-811b1ce65ac5d60dd553140c261759fd",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>修改 <code>emqx_backend_mysql.app.src</code> 内容，无关紧要的可以先不用改</p><div class="code-block code-block-container-indented"><pre><code id=code-9fcabeb1b397c137d9520be2f9faf043>{application, emqx_backend_mysql,
 [{description, &#34;EMQ X Backend Mysql&#34;},
  {vsn, &#34;git&#34;},
  {modules, []},
  {registered, [emqx_backend_mysql_sup]},
  {applications, [kernel,stdlib]},
  {mod, {emqx_backend_mysql_app,[]}},
  {env, []},
  {licenses, [&#34;Apache-2.0&#34;]},
  {maintainers, [&#34;EMQ X Team &lt;contact@emqx.io&gt;&#34;]},
  {links, [{&#34;Homepage&#34;, &#34;https://emqx.io/&#34;},
           {&#34;Github&#34;, &#34;https://github.com/emqx/emqx-plugin-template&#34;}
          ]}
 ]}.</code></pre><button class=copy-code-button onclick='copyCode("code-9fcabeb1b397c137d9520be2f9faf043",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>最终 <code>src</code> 下的文件结构</p><div class="code-block code-block-container-indented"><pre><code id=code-24022bbd51ea7b359e4031b7d709900c>src/
├── emqx_backend_mysql_actions.erl
├── emqx_backend_mysql.app
├── emqx_backend_mysql_app.erl
├── emqx_backend_mysql.app.src
├── emqx_backend_mysql.app.src.script
├── emqx_backend_mysql_batcher.erl
├── emqx_backend_mysql_cli.erl
├── emqx_backend_mysql.erl
└── emqx_backend_mysql_sup.erl

0 directories, 9 files</code></pre><button class=copy-code-button onclick='copyCode("code-24022bbd51ea7b359e4031b7d709900c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>将从容器中复制出来的 <code>emqx_backend_mysql</code> 插件中的 <code>include</code> 和 <code>priv</code> 目录都复制到新建的插件目录 将 <code>emqx</code> 企业版的配置文件 <code>/etc/plugins/emqx_backend_mysql.conf</code> 复制到新插件的 <code>etc</code> 目录</p><p><a id=orgaadf956></a></p><h2 id=搭建临时-git-服务>搭建临时 git 服务</h2><p><code>emqx</code> 在构建时添加的插件需要能从 git 仓库中拉取，先在本地搭建一个临时的 git 服务用于测试</p><div class="code-block code-block-container-indented"><pre><code id=code-e211827e56f509e7ff6504382277c49c>mdir -p ~/Downloads/Git/emqx_backend_mysql.git
cd ~/Downloads/Git/emqx_backend_mysql.git
git init --bare
git daemon --verbose --export-all --enable=receive-pack --base-path=/home/cheon/Downloads/Git</code></pre><button class=copy-code-button onclick='copyCode("code-e211827e56f509e7ff6504382277c49c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这样一个临时的 git 服务就搭建好了，在新建的插件目录进行关联远程仓库并提交</p><div class="code-block code-block-container-indented"><pre><code id=code-97f4d008b62aa249cc8e6a0dceb36df6>git remote set-url git://localhost/emqx_backend_mysql.git
git add .
git commit -m &#34;init&#34;
git push origin master</code></pre><button class=copy-code-button onclick='copyCode("code-97f4d008b62aa249cc8e6a0dceb36df6",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p><a id=org2054d0d></a></p><h2 id=重新编译>重新编译</h2><p>修改 <code>rebar.config</code></p><div class="code-block code-block-container-indented"><pre><code id=code-e0061739f96ed5d9059c7d2843deefd2>  {deps,
     [ {emqx_backend_mysql, {git, &#34;git://localhost/emqx-backend-mysql.git&#34;, {branch, &#34;master&#34;}}}
     , ....
     ....
     ]
  }
  ...
{relx,
    [...
    , ...
    , {release, {emqx, git_describe},
       [
         {emqx_backend_mysql, load},
       ]
      }
    ]
}</code></pre><button class=copy-code-button onclick='copyCode("code-e0061739f96ed5d9059c7d2843deefd2",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>修改完成后重新编译，打开 <code>localhost:18083</code> 的插件栏可以看到 <code>emqx_backend_mysql</code> 插件。</p><p><a id=org773634b></a></p><h2 id=测试插件>测试插件</h2><p>修改插件配置文件 <code>_build/emqx/rel/emqx/etc/plugins/emqx_backend_mysql.conf</code></p><div class="code-block code-block-container-indented"><pre><code id=code-27823437fba077a8f28819f8754e5da7>##====================================================================
## Configuration for EMQ X MySQL Backend
##====================================================================

## MySQL Server
backend.mysql.pool1.server = 172.17.0.2:3306

## MySQL Pool Size
backend.mysql.pool1.pool_size = 8
## MySQL Username
backend.mysql.pool1.user = root
## MySQL Password
backend.mysql.pool1.password = 1qaz!QAZ
## MySQL Database
backend.mysql.pool1.database = mqtt

## Client Connected Record 
backend.mysql.hook.client.connected.1    = {&#34;action&#34;: {&#34;function&#34;: &#34;on_client_connected&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Session Created Record 
backend.mysql.hook.client.connected.2     = {&#34;action&#34;: {&#34;function&#34;: &#34;on_subscribe_lookup&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Client DisConnected Record 
backend.mysql.hook.client.disconnected.1 = {&#34;action&#34;: {&#34;function&#34;: &#34;on_client_disconnected&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Lookup Unread Message QOS &gt; 0
backend.mysql.hook.session.subscribed.1  = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_message_fetch&#34;}, &#34;offline_opts&#34;: {&#34;max_returned_count&#34;: 500, &#34;time_range&#34;: &#34;2h&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Lookup Retain Message
backend.mysql.hook.session.subscribed.2  = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_retain_lookup&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Delete Acked Record
backend.mysql.hook.session.unsubscribed.1= {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;sql&#34;: [&#34;delete from mqtt_acked where clientid = ${clientid} and topic = ${topic}&#34;]}, &#34;pool&#34;: &#34;pool1&#34;}

## Store Publish Message QOS &gt; 0
backend.mysql.hook.message.publish.1     = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_message_publish&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Store Retain Message
backend.mysql.hook.message.publish.2     = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_message_retain&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Delete Retain Message
backend.mysql.hook.message.publish.3     = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_retain_delete&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Store Ack
backend.mysql.hook.message.acked.1       = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_message_acked&#34;}, &#34;pool&#34;: &#34;pool1&#34;}

## Max number of fetch offline messages
## max_returned_count = 500

## Time Range
## d - day
## h - hour
## m - minute
## s - second
## time_range = 2h
## backend.mysql.hook.session.subscribed.1  = {&#34;topic&#34;: &#34;#&#34;, &#34;action&#34;: {&#34;function&#34;: &#34;on_message_fetch&#34;}, &#34;offline_opts&#34;: {&#34;max_returned_count&#34;: 500, &#34;time_range&#34;: &#34;2h&#34;}, &#34;pool&#34;: &#34;pool1&#34;}</code></pre><button class=copy-code-button onclick='copyCode("code-27823437fba077a8f28819f8754e5da7",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>在 dashboard 插件栏点击启用 <code>emqx_backend_mysql</code> 即可启用成功，也可以通过命令行来启用</p><div class="code-block code-block-container-indented"><pre><code id=code-6ecf1ee442d32ba42eaa2991cfbfa4c6>bin/emqx_ctl plugins load emqx_backend_mysql</code></pre><button class=copy-code-button onclick='copyCode("code-6ecf1ee442d32ba42eaa2991cfbfa4c6",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>如果启用失败，可以查看日志文件 <code>log/emqx.log.1</code> 启用成功后，可以根据 <a href=https://docs.emqx.net/enterprise/latest/cn/rule/rule-example.html#%E4%BB%8E-pulsar-%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF%E5%88%B0-emq-x>官方文档</a> 来测试该插件</p><p><a id=org314e5bf></a></p><h2 id=构建镜像>构建镜像</h2><p><code>emqx-rel</code> 项目自带构建镜像的功能</p><div class="code-block code-block-container-indented"><pre><code id=code-a2898a536056b5e14a5aa4251990bbd7>make emqx-docker-build</code></pre><button class=copy-code-button onclick='copyCode("code-a2898a536056b5e14a5aa4251990bbd7",this)' title=copy>
<i class="fa fa-copy"></i></button></div></article></div></main><div><h4 id=signature>Wed Oct 14, 2020
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/iot>iot</a></li><li><a href=https://number317.github.io/blog/tags/emqx>emqx</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/org_blog_with_hugo/>用 hugo 组织 org 文件写博客</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>