<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="description" content=Aloha!&#32;Welcome&#32;to&#32;cheon&#39;s&#32;blog.>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes= "76x76" href=https://number317.github.io/blog/img/apple-touch-icon.png>
    <link rel="icon" href=https://number317.github.io/blog/img/pen.svg>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/global.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/nav.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/header.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/index.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/list.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/single.css>
    <link rel="stylesheet" href=https://number317.github.io/blog/css/footer.css>
    
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel="stylesheet">
    
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>cheon&#39;s blog</title>

</head>
<body><section id="header">
    <ul id="menus">
    
    <li class="menu"><a href="https://number317.github.io"><span>Home</span></a></li>
    
    <li class="menu"><a href="https://number317.github.io/blog/categories"><span>Categories</span></a></li>
    
    <li class="menu"><a href="https://number317.github.io/blog/tags"><span>Tags</span></a></li>
    
    <li class="menu"><a href="https://github.com/number317"><span>Projects</span></a></li>
    
    </ul>
    <h1 id="title"><a href="https://number317.github.io/blog/">cheon&#39;s blog</a></h1>
</section>
<ul id="nav">






<li>
    »
    <a href="https://number317.github.io/blog/">
    
    cheon&#39;s blog
    
    </a>
</li>


<li>
    »
    <a href="https://number317.github.io/blog/categories/struct/">
    
    struct
    
    
    </a>
</li>


<li class="active">
    »
    <a href="https://number317.github.io/blog/struct/react_embed_tableau.html">
    
    React Embed Tableau
    
    </a>
</li>

</ul>

<div id="content">
<main id="main">
  <h1>React Embed Tableau</h1>
  <time>Last updated Sun May 7, 2023</time>
  <div>
      <aside>
          <h2>Table of Content</h1>
          <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">React 嵌入 Tableau 图表</a>
<ul>
<li><a href="#headline-2">前置工作</a>
</li>
<li><a href="#headline-3">嵌入代码</a>
<ul>
<li><a href="#headline-4">引入 js</a>
</li>
<li><a href="#headline-5">编写组件</a>
</li>
</ul>
</li>
<li><a href="#headline-6">疑难杂症</a>
</li>
</ul>
</li>
</ul>
</nav>
      </aside>
      <article id="content">
          
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
React 嵌入 Tableau 图表
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
前置工作
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<p>想要将 tableau server 的图表嵌入网页中，首先要解决的是身份认证的问题。工作原理可以参考<a href="https://help.tableau.com/current/server/zh-cn/trusted_auth.htm">官方文档</a>。
从文档中可以看出，要解决以下几个问题：</p>
<ul>
<li>采用兑换票证（ticket）的方式来进行身份验证，需要将发送获取票证的服务器添加到 tableau server 的受信任列表中。</li>
<li>为了让用户在访问嵌入视图时成功进行身份验证而不提示登录，浏览器必须配置为允许第三方 Cookie。经过测试，发现 chrome, safari 默认关闭了第三方 Cookie 的支持，firefox 默认支持第三方 Cookie。</li>
<li>如果要嵌入工作簿，需要提升票证的权限。</li>
</ul>
<p>当服务器已经加入到 tableau server 的受信任列表中（注意添加完需要重启 tableau server 服务），可以在该服务器上执行如下命令来测试获取票证是否成功（注意将地址，用户名和站点名替换成实际值）：</p>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST https://your.tableau.addr/trusted?username=username&amp;<span style="color:#666;font-weight:bold;font-style:italic">target_site</span>=sitename</span></span></code></pre></div>
</div>
<p>
如果返回 -1，说明配置还有地方不对，没能正确地获取到票证。</p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
嵌入代码
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<div id="outline-container-headline-4" class="outline-4">
<h4 id="headline-4">
引入 js
</h4>
<div id="outline-text-headline-4" class="outline-text-4">
<p>首先需要引入 tableau server 的 js 文件。这里用的是 2019.1 的 tableau server 版本。然而根据<a href="https://help.tableau.com/v2019.1/api/js_api/en-us/JavaScriptAPI/js_api_concepts_get_API.htm">官方文档</a>上记载的 js 版本引入之后发现用不了，最后测试出来应该引用 tableau-2.2.2.min.js 文件。</p>
<p>
在 react 中引入外部 js 文件可以使用如下方法：</p>
<details>
<summary><code>loadScript(url, callback)</code></summary>
<div class="src src-js">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>  <span style="font-weight:bold;font-style:italic">function</span> loadScript(url, callback) {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> script = <span style="font-weight:bold;font-style:italic">document</span>.createElement(<span style="color:#666;font-style:italic">&#39;script&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> (script.readyState) { <span style="color:#888;font-style:italic">// IE
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>      script.onreadystatechange = () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> (script.readyState === <span style="color:#666;font-style:italic">&#39;loaded&#39;</span> || script.readyState === <span style="color:#666;font-style:italic">&#39;complete&#39;</span>) {
</span></span><span style="display:flex;"><span>          script.onreadystatechange = <span style="font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>          callback();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    } <span style="font-weight:bold">else</span> { <span style="color:#888;font-style:italic">// 其他浏览器
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>      script.onload = () =&gt; {
</span></span><span style="display:flex;"><span>        callback();
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    script.src = url;
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">document</span>.getElementsByTagName(<span style="color:#666;font-style:italic">&#39;head&#39;</span>)[0].appendChild(script);
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
</div>
</details>
<p>
<code class="verbatim">url</code> 就是要引入 js 的地址， <code class="verbatim">callback</code> 就是在 js 引入后要执行的操作，这样可以确保 <code class="verbatim">callback</code> 函数在 js 加载完成后再执行。</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-4">
<h4 id="headline-5">
编写组件
</h4>
<div id="outline-text-headline-5" class="outline-text-4">
<p>由于所有的 tableau 图表的嵌入都是一样的，所以我们可以将其分装为组件，代码如下：</p>
<details>
<summary><code>TableauView(url, interval = 60 * 1000)</code></summary>
<div class="src src-js">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>  <span style="font-weight:bold">const</span> TableauView = (props) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> { url, interval = 60 * 1000 } = props;
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> vizRef = useRef(<span style="font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">const</span> [ticket, setTicket] = useState(<span style="color:#666;font-style:italic">&#39;init&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">let</span> viz;
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">let</span> timer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    useEffect(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">async</span> <span style="font-weight:bold;font-style:italic">function</span> initViz() {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> (!viz) {
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">const</span> { tableau } = <span style="font-weight:bold;font-style:italic">window</span>;
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">const</span> res = <span style="font-weight:bold">await</span> axios.get(<span style="color:#666;font-style:italic">&#39;/auth/ticket&#39;</span>);
</span></span><span style="display:flex;"><span>          setTicket(res);
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">if</span> (res === -1) {
</span></span><span style="display:flex;"><span>            message.warn(<span style="color:#666;font-style:italic">&#39;获取票证失败，需手动登录tableau server&#39;</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">const</span> options = {
</span></span><span style="display:flex;"><span>            hideToolbar: <span style="font-weight:bold">false</span>,
</span></span><span style="display:flex;"><span>            height: <span style="color:#666;font-style:italic">&#39;calc(100vh - 1rem)&#39;</span>,
</span></span><span style="display:flex;"><span>            width: <span style="color:#666;font-style:italic">&#39;100%&#39;</span>,
</span></span><span style="display:flex;"><span>            onFirstInteractive: () =&gt; {
</span></span><span style="display:flex;"><span>              <span style="color:#888;font-style:italic">// setInterval(() =&gt; viz.refreshDataAsync(), interval);
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>            },
</span></span><span style="display:flex;"><span>          };
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">const</span> ticketUrl = url.replace(<span style="color:#666;font-style:italic">&#39;/t/&#39;</span>, <span style="color:#666;font-style:italic">&#39;/trusted/&#39;</span>).replace(<span style="color:#666;font-style:italic">&#39;/username/&#39;</span>, <span style="color:#666;font-style:italic">`/</span><span style="color:#666;font-style:italic">${</span>res<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/t/username/`</span>);
</span></span><span style="display:flex;"><span>          viz = <span style="font-weight:bold">new</span> tableau.Viz(vizRef.current, res === -1 ? url : ticketUrl, options);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        timer = setInterval(() =&gt; viz.refreshDataAsync(), interval);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">if</span> (MenuStore.activeMenu?.route === route) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> (<span style="font-weight:bold;font-style:italic">window</span>.tableau) {
</span></span><span style="display:flex;"><span>          initViz();
</span></span><span style="display:flex;"><span>        } <span style="font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>          loadScript(<span style="color:#666;font-style:italic">&#39;http://test.tableau.server.com/javascripts/api/tableau-2.2.2.min.js&#39;</span>, initViz);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      } <span style="font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        clearInterval(timer);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">return</span> () =&gt; {
</span></span><span style="display:flex;"><span>        clearInterval(timer);
</span></span><span style="display:flex;"><span>        viz?.dispose();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }, [MenuStore.activeMenu?.route, route]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> ticket === <span style="color:#666;font-style:italic">&#39;init&#39;</span> ? &lt;Spin loading /&gt; : &lt;div ref={vizRef} /&gt;;
</span></span><span style="display:flex;"><span>  };</span></span></code></pre></div>
</div>
</details>
<p>
注意将上面的接口地址，tableau server 地址，用户名都替换为实际值。参数中的 <code class="verbatim">url</code> 就是 tableau server 图表分享的地址，在组件中做了转换； <code class="verbatim">interval</code> 就是自动刷新的时间间隔，默认为60s。</p>
<p>
组件编写完成，只需要在想要展示的页面引用即可。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
疑难杂症
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<ul>
<li>firefox 刷新报错</li>
</ul>
<p><img src="./images/react_embed_tableau_1.jpg" alt="./images/react_embed_tableau_1.jpg" title="./images/react_embed_tableau_1.jpg" /></p>
<p>
在同一个页面内如果刷新了多个分享的链接，在 firefox 上会报错，但是在 chrome 上没有报错。经过排查是 tableau server 的 js 报错，暂时没有别的解决方法，只能限制在同一时间只刷新展示的图表。</p>
<ul>
<li>隐藏 tableu 图表刷新时的 loading</li>
</ul>
<p>这是 tableau server 自带的加载样式，在网页中嵌入时其实是用 <code class="verbatim">iframe</code> 来嵌入的，所以如果网页和 tableau 连接不是同一个域名会有跨域问题，无法修改样式。如果不是跨域则可以覆盖原有样式。</p>
</div>
</div>
</div>
</div>

      </article>
  </div>
</main>

<div>
    <h4 id="signature">
        Sun Nov 22, 2020
        
            cheon
        
    </h4>
    
    
    <ul class="tags">
        
            <li> <a href="https://number317.github.io/blog/tags/react">react</a> </li>
        
            <li> <a href="https://number317.github.io/blog/tags/tableau">tableau</a> </li>
        
    </ul>
    
    <ul class="related">
        
            <li><a class="previous" href="https://number317.github.io/blog/struct/emqx_backend_mysql.html"> Emqx Backend Mysql</a></li>
        
        
    </ul>
</div>

        </div><section id="footer">

<div id="author">
    <h2>About Author</h2>
    <hr>
    <img src=https://number317.github.io/images/author.jpg></img>
    <p>Life is dance we all have to do.</p>
</div>
<ul id="link">
    <li><a href=https://github.com/number317/aloha.git target="_blank"><i class="fa fa-github" alt="github"></i></a></li>
    <li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target="_blank"><i class="fa fa-envelope" alt="email"></i></a></li>
    <li id="wechat"><i class="fa fa-wechat"></i></li>
    <img class="qrcode" src=https://number317.github.io/images/wechat.jpg>
</ul>
</section>
</body>
</html>
