<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/skywalking_deploy/>Skywalking Deploy</a></li></ul><div id=content><main id=main><h1>Skywalking Deploy</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#架构说明>架构说明</a></li><li><a href=#部署>部署</a></li><li><a href=#java-应用接入-agent>Java 应用接入 agent</a></li><li><a href=#tomcat-接入-agent>Tomcat 接入 agent</a></li><li><a href=#添加-oracle-数据库插件>添加 oracle 数据库插件</a></li></ul></nav></aside><article id=content><h1 id=skywalking-部署>skywalking 部署</h1><p>skywalking 是一个国产开源的调用链监控工具，可用于分析请求中哪些操作比较慢。<a href=https://github.com/apache/skywalking-kubernetes>官方</a>提供了 k8s 的部署配置，但这个配置里的镜像是不对的，具体版本对应的镜像可以在<a href=https://hub.docker.com/r/apache/skywalking-oap-server>Dockerhub</a>上找到。如果想要更换版本，最好把 ES 中的索引先删除，否则可能会导致应用报错。</p><h2 id=架构说明>架构说明</h2><ul><li>elasticsearch: 用于存储 skywalking 数据，这里使用的是腾讯云的 ES 服务，因此无需搭建</li><li>skywalking-oap-server: skywalking 后端</li><li>ui: 默认 ui 界面</li><li><a href=https://github.com/apache/skywalking-rocketbot-ui>rocketbot-ui</a>: skywalking 的另一个官方前端界面，没有现成的镜像，需要自己构建</li></ul><h2 id=部署>部署</h2><p>将官方的部署文件克隆到本地，将 oap， ui 的镜像换成对应的版本镜像。修改 oap 配置中的 ES 地址：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>storage:
</span></span><span style=display:flex><span>  elasticsearch:
</span></span><span style=display:flex><span>    clusterNodes: elasticsearch:9200
</span></span></code></pre></div><p>先创建命名空间：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns skywalking
</span></span></code></pre></div><p>接着部署 oap 后端：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f oap/
</span></span></code></pre></div><p>再部署前端：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ui/
</span></span></code></pre></div><p>为了集群外部访问，可以为前端配置一个域名或者在 service 中添加 externalIPs。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions/v1beta1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  generation: 1
</span></span><span style=display:flex><span>  name: ui
</span></span><span style=display:flex><span>  namespace: skywalking
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: skywalking.test.com.
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - backend:
</span></span><span style=display:flex><span>          serviceName: ui
</span></span><span style=display:flex><span>          servicePort: 80
</span></span><span style=display:flex><span>        path: /
</span></span></code></pre></div><p>rocketbot-ui 属于可选配置，配置文件如下：</p><details><summary>rocketbot-ui 部署文件</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>---</span>
</span></span><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: rocketbot-ui
</span></span><span style=display:flex><span>  namespace: skywalking
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: rocketbot-ui
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: rocketbot-ui
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: rocketbot-ui
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: rocketbot-ui
</span></span><span style=display:flex><span>        image: rocketbot-ui:v1.0.3
</span></span><span style=display:flex><span>        env:
</span></span><span style=display:flex><span>        - name: TZ
</span></span><span style=display:flex><span>          value: <span style=color:#666;font-style:italic>&#34;Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: 80
</span></span><span style=display:flex><span>          name: page
</span></span><span style=display:flex><span>        resources:
</span></span><span style=display:flex><span>          requests:
</span></span><span style=display:flex><span>            memory: 1Gi
</span></span><span style=display:flex><span>          limits:
</span></span><span style=display:flex><span>            memory: 2Gi
</span></span><span style=display:flex><span>        env:
</span></span><span style=display:flex><span>        - name: SKYWALKING_URL
</span></span><span style=display:flex><span>          value: oap:12800
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>---</span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: rocketbot-ui
</span></span><span style=display:flex><span>  namespace: skywalking
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    service: rocketbot-ui
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>  - port: 80
</span></span><span style=display:flex><span>    name: http
</span></span><span style=display:flex><span>    targetPort: page
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: rocketbot-ui
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>---</span>
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  generation: 1
</span></span><span style=display:flex><span>  name: rocketbot-ui
</span></span><span style=display:flex><span>  namespace: skywalking
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: rocketbot-ui.test.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - backend:
</span></span><span style=display:flex><span>          serviceName: rocketbot-ui
</span></span><span style=display:flex><span>          servicePort: 80
</span></span><span style=display:flex><span>        path: /
</span></span></code></pre></div></details><h2 id=java-应用接入-agent>Java 应用接入 agent</h2><p>将 Java 应用接入 skywalking 需要下载对应版本的 agent，比如上面部署的版本是 6.0.0-GA，那么就在 skywalking 的 <a href=https://github.com/apache/skywalking/releases>release</a> 页面找到对应的版本下载（如果版本对应不上通常会报错）。下载完解压可以找到一个 agent 目录。修改 <code>agent/config/agent.config</code> 配置文件，一般主要修改四个配置：</p><ul><li>agent.service_name: 在界面上显示的应用名字</li><li>agent.ignore_suffix: 忽略以哪些为后缀的请求，通常忽略前端资源，如<code>.jpg,.jpeg,.js,.css,.png,.bmp,.gif,.ico,.mp3,.mp4,.html,.svg</code></li><li>collector.backend_service: oap 后端的地址，默认端口是 11800，在同一集群中的应用可以用 oap svc 地址，集群外的应用想要访问需要为 oap 的 svc 配置 externalIPs</li><li>logging.level: oap 的日志级别，在 <code>agent/logs</code> 目录下可以看到日志文件，通常写 <code>info</code> 级别即可</li></ul><p>启动 Java 应用</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>java <span style=color:#666;font-weight:700;font-style:italic>$JAVA_OPTS</span> -javaagent:/agent/skywalking-agent.jar -jar app.jar
</span></span></code></pre></div><h2 id=tomcat-接入-agent>Tomcat 接入 agent</h2><p>在 catalina.sh 启动脚本中添加以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=font-weight:700>if</span> [[ <span style=color:#666;font-weight:700;font-style:italic>$ENABLE_SKAGENT</span> == <span style=font-weight:700;font-style:italic>true</span> ]]; <span style=font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#666;font-weight:700;font-style:italic>CATALINA_OPTS</span>=<span style=color:#666;font-style:italic>&#34;</span><span style=color:#666;font-weight:700;font-style:italic>$CATALINA_OPTS</span><span style=color:#666;font-style:italic> -javaagent:/agent/skywalking-agent.jar&#34;</span>; <span style=font-weight:700;font-style:italic>export</span> CATALINA_OPTS
</span></span><span style=display:flex><span><span style=font-weight:700>fi</span>
</span></span></code></pre></div><p>这里添加了条件判断是为了在容器中使用时可以方便地通过环境变量来控制是否启用 skywalking。</p><h2 id=添加-oracle-数据库插件>添加 oracle 数据库插件</h2><p>agent 里默认不带 oracle 数据库的插件，所以在请求中无法解析 oracle 数据库的操作。可以在<a href=https://github.com/OpenSkywalking/java-plugin-extensions>java-plugin-extensions</a>下载 oracle 数据库的插件，并将插件 jar 包文件放到 <code>agent/plugins</code> 目录下，重启应用就可以看到 oracle 数据库的操作了。</p></article></div></main><div><h4 id=signature>Thu Apr 25, 2019
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/aop>aop</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/graylog_sidecar/>Graylog Sidecar</a></li><li><a class=next href=https://number317.github.io/blog/struct/docker_graph_migrate/>Docker Graph Migrate</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>