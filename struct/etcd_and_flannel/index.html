<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/etcd_and_flannel/>Etcd & Flannel</a></li></ul><div id=content><main id=main><h1>Etcd & Flannel</h1><time>Last updated Tue Dec 17, 2024</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#启动虚拟机>启动虚拟机</a></li><li><a href=#通用配置>通用配置</a></li><li><a href=#node1-配置>node1 配置</a></li><li><a href=#node2-配置>node2 配置</a></li><li><a href=#启动容器进行测试>启动容器进行测试</a></li></ul></nav></aside><article id=content><h1 id=etcd--flannel-实现跨主机容器通信>etcd & flannel 实现跨主机容器通信</h1><h2 id=准备工作>准备工作</h2><ol><li>测试环境：vagrant + centos7.2 虚拟机</li><li>主机说明：<ul><li>ip: <code>192.168.12.101</code> hostname: <code>node1</code> 安装软件：etcd, flannel, docker</li><li>ip: <code>192.168.12.102</code> hostname: <code>node2</code> 安装软件：flannel, docker</li></ul></li></ol><h2 id=启动虚拟机>启动虚拟机</h2><p>vagrant配置文件：</p><details><summary>Vagrantfile</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#888;font-style:italic># -*- mode: ruby -*-</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># vi: set ft=ruby :</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>Vagrant</span>.configure(2) <span style=font-weight:700>do</span> |config|
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    (1..2).each <span style=font-weight:700>do</span> |i|
</span></span><span style=display:flex><span>        config.vm.define <span style=color:#666;font-style:italic>&#34;node</span><span style=color:#666;font-style:italic>#{</span>i<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span> <span style=font-weight:700>do</span> |s|
</span></span><span style=display:flex><span>            s.vm.box = <span style=color:#666;font-style:italic>&#34;bento/centos-7.2&#34;</span>
</span></span><span style=display:flex><span>            s.vm.hostname = <span style=color:#666;font-style:italic>&#34;node</span><span style=color:#666;font-style:italic>#{</span>i<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span>            n = 100 + i
</span></span><span style=display:flex><span>            s.vm.network <span style=color:#666;font-style:italic>&#34;private_network&#34;</span>, <span style=color:#666;font-style:italic>ip</span>: <span style=color:#666;font-style:italic>&#34;192.168.12.</span><span style=color:#666;font-style:italic>#{</span>n<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span>            s.ssh.username = <span style=color:#666;font-style:italic>&#34;vagrant&#34;</span>
</span></span><span style=display:flex><span>            s.ssh.password = <span style=color:#666;font-style:italic>&#34;vagrant&#34;</span>
</span></span><span style=display:flex><span>            s.ssh.insert_key = <span style=font-weight:700>false</span>
</span></span><span style=display:flex><span>            s.vm.provider <span style=color:#666;font-style:italic>&#34;virtualbox&#34;</span> <span style=font-weight:700>do</span> |v|
</span></span><span style=display:flex><span>                v.name = <span style=color:#666;font-style:italic>&#34;node</span><span style=color:#666;font-style:italic>#{</span>i<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span><span style=display:flex><span>                v.cpus = 1
</span></span><span style=display:flex><span>                v.memory = 1024
</span></span><span style=display:flex><span>            <span style=font-weight:700>end</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>end</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>end</span>
</span></span><span style=display:flex><span><span style=font-weight:700>end</span>
</span></span></code></pre></div></details><p>在该配置文件的目录下执行<code>vagrant up</code>启动两台测试用虚拟机</p><h2 id=通用配置>通用配置</h2><p><strong>以下操作在 node1 和 node2 上都需要配置</strong></p><ol><li><p>关闭，禁用防火墙：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl stop firewalld
</span></span><span style=display:flex><span>sudo systemctl disable firewalld
</span></span></code></pre></div></li><li><p>安装需要软件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum install -y epel-release docker flannel
</span></span></code></pre></div></li></ol><h2 id=node1-配置>node1 配置</h2><ol><li><p>安装etcd：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum install -y etcd
</span></span></code></pre></div></li><li><p>修改etcd的配置文件<code>/etc/etcd/etcd.conf</code>为如下内容，修改前可以先备份原来的配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>ETCD_NAME=master
</span></span><span style=display:flex><span>ETCD_DATA_DIR=<span style=color:#666;font-style:italic>&#34;/var/lib/etcd/default.etcd&#34;</span>
</span></span><span style=display:flex><span>ETCD_LISTEN_CLIENT_URLS=<span style=color:#666;font-style:italic>&#34;http://0.0.0.0:2379,http://0.0.0.0:4001&#34;</span>
</span></span><span style=display:flex><span>ETCD_ADVERTISE_CLIENT_URLS=<span style=color:#666;font-style:italic>&#34;http://192.168.12.101:2379,http://192.168.12.101:4001&#34;</span>
</span></span></code></pre></div></li><li><p>启动etcd，并设置开机自启动：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start etcd
</span></span><span style=display:flex><span>sudo systemctl <span style=font-weight:700;font-style:italic>enable</span> etcd
</span></span></code></pre></div></li><li><p>测试etcd状态：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl -C http://192.168.12.101:2379 cluster-health
</span></span><span style=display:flex><span>etcdctl -C http://192.168.12.101:4001 cluster-health
</span></span></code></pre></div></li><li><p>安装flannel：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum -y install flannel
</span></span></code></pre></div></li><li><p>修改flannel的配置文件<code>/etc/sysconfig/flanneld</code>为如下内容，修改前可以先备份原来的配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FLANNEL_ETCD=&#34;http://192.168.12.101:2379&#34;
</span></span><span style=display:flex><span>FLANNEL_ETCD_KEY=&#34;/atomic.io/network&#34;
</span></span><span style=display:flex><span>FLANNEL_OPTIONS=&#34;--iface=enp0s8&#34;
</span></span></code></pre></div><p>注意，配置文件里的<code>--iface=enp0s8</code>配置的是网卡，可以用<code>ip addr</code>命令查看，如果不配置网卡，可能会给不同主机的容器分配相同的ip地址</p></li><li><p>在etcd中设置flannel的key，用来保证多个flannel实例间的配置一致性：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl mk /atomic.io/network/config <span style=color:#666;font-style:italic>&#39;{&#34;Network&#34;: &#34;192.168.0.0/16&#34;}&#39;</span>
</span></span></code></pre></div><p>设置的key要和flannel配置的相同。<code>Network</code>后的ip地址可以任意设定网段，容器ip会根据该网段自动分配。</p></li><li><p>启动flannel，重启docker，使flannel分配的ip生效：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start flannel
</span></span><span style=display:flex><span>sudo systemctl <span style=font-weight:700;font-style:italic>enable</span> flannel
</span></span><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div></li></ol><h2 id=node2-配置>node2 配置</h2><ol><li><p>修改flannel的配置文件<code>/etc/sysconfig/flanneld</code>为如下内容，修改前可以先备份原来的配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FLANNEL_ETCD=&#34;http://192.168.12.101:2379&#34;
</span></span><span style=display:flex><span>FLANNEL_ETCD_KEY=&#34;/atomic.io/network&#34;
</span></span><span style=display:flex><span>FLANNEL_OPTIONS=&#34;--iface=enp0s8&#34;
</span></span></code></pre></div><p>注意，配置文件里的<code>--iface=enp0s8</code>配置的是网卡，可以用<code>ip addr</code>命令查看，如果不配置网卡，可能会给不同主机的容器分配相同的ip地址</p></li><li><p>启动flannel，重启docker，使flannel分配的ip生效：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start flannel
</span></span><span style=display:flex><span>sudo systemctl <span style=font-weight:700;font-style:italic>enable</span> flannel
</span></span><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div></li></ol><h2 id=启动容器进行测试>启动容器进行测试</h2><ol><li><p>在node1和node2中分别运行一个容器：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker run -it ubuntu:14.04
</span></span></code></pre></div></li><li><p>在两个容器中互相ping对方ip，如果配置成功，则应该能ping通。否则请检查配置是否有错误，尤其是flannel配置网卡。</p></li></ol></article></div></main><div><h4 id=signature>Wed Nov 1, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/etcd>etcd</a></li><li><a href=https://number317.github.io/blog/tags/flannel>flannel</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/rabbitmq_access_control/>Rabbitmq Access Control</a></li><li><a class=next href=https://number317.github.io/blog/struct/maven_nexus/>Maven & Nexus</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>