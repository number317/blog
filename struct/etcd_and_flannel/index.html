<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/etcd_and_flannel/>Etcd & Flannel</a></li></ul><div id=content><main id=main><h1>Etcd & Flannel</h1><time>Last updated Tue Dec 17, 2024</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#启动虚拟机>启动虚拟机</a></li><li><a href=#通用配置>通用配置</a></li><li><a href=#node1-配置>node1 配置</a></li><li><a href=#node2-配置>node2 配置</a></li><li><a href=#启动容器进行测试>启动容器进行测试</a></li></ul></nav></aside><article id=content><h1 id=etcd--flannel-实现跨主机容器通信>etcd & flannel 实现跨主机容器通信</h1><h2 id=准备工作>准备工作</h2><ol><li>测试环境：vagrant + centos7.2 虚拟机</li><li>主机说明：<ul><li>ip: <code>192.168.12.101</code> hostname: <code>node1</code> 安装软件：etcd, flannel, docker</li><li>ip: <code>192.168.12.102</code> hostname: <code>node2</code> 安装软件：flannel, docker</li></ul></li></ol><h2 id=启动虚拟机>启动虚拟机</h2><p>vagrant配置文件：</p><details><summary>Vagrantfile</summary><div class="code-block code-block-container-indented"><pre><code id=code-79bc2db050898cf217e1170ae6fe9ae4># -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|

    (1..2).each do |i|
        config.vm.define &#34;node#{i}&#34; do |s|
            s.vm.box = &#34;bento/centos-7.2&#34;
            s.vm.hostname = &#34;node#{i}&#34;
            n = 100 &#43; i
            s.vm.network &#34;private_network&#34;, ip: &#34;192.168.12.#{n}&#34;
            s.ssh.username = &#34;vagrant&#34;
            s.ssh.password = &#34;vagrant&#34;
            s.ssh.insert_key = false
            s.vm.provider &#34;virtualbox&#34; do |v|
                v.name = &#34;node#{i}&#34;
                v.cpus = 1
                v.memory = 1024
            end
        end
    end
end</code></pre><button class=copy-code-button onclick='copyCode("code-79bc2db050898cf217e1170ae6fe9ae4",this)' title=copy>
<i class="fa fa-copy"></i></button></div></details><p>在该配置文件的目录下执行<code>vagrant up</code>启动两台测试用虚拟机</p><h2 id=通用配置>通用配置</h2><p><strong>以下操作在 node1 和 node2 上都需要配置</strong></p><ol><li><p>关闭，禁用防火墙：</p><div class="code-block code-block-container-indented"><pre><code id=code-f9963c151133741309dda49bddaa6339>sudo systemctl stop firewalld
sudo systemctl disable firewalld</code></pre><button class=copy-code-button onclick='copyCode("code-f9963c151133741309dda49bddaa6339",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>安装需要软件：</p><div class="code-block code-block-container-indented"><pre><code id=code-896fdbacda75ef2ca409db911399866c>sudo yum install -y epel-release docker flannel</code></pre><button class=copy-code-button onclick='copyCode("code-896fdbacda75ef2ca409db911399866c",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li></ol><h2 id=node1-配置>node1 配置</h2><ol><li><p>安装etcd：</p><div class="code-block code-block-container-indented"><pre><code id=code-b5e2ae982adf174da9d49676ccbbd2b6>sudo yum install -y etcd</code></pre><button class=copy-code-button onclick='copyCode("code-b5e2ae982adf174da9d49676ccbbd2b6",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>修改etcd的配置文件<code>/etc/etcd/etcd.conf</code>为如下内容，修改前可以先备份原来的配置文件：</p><div class="code-block code-block-container-indented"><pre><code id=code-3171409c2ac31f6406f1a16a47b99492>ETCD_NAME=master
ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
ETCD_LISTEN_CLIENT_URLS=&#34;http://0.0.0.0:2379,http://0.0.0.0:4001&#34;
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.12.101:2379,http://192.168.12.101:4001&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-3171409c2ac31f6406f1a16a47b99492",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>启动etcd，并设置开机自启动：</p><div class="code-block code-block-container-indented"><pre><code id=code-57569658c95e9969433124b25f1fd0ef>sudo systemctl start etcd
sudo systemctl enable etcd</code></pre><button class=copy-code-button onclick='copyCode("code-57569658c95e9969433124b25f1fd0ef",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>测试etcd状态：</p><div class="code-block code-block-container-indented"><pre><code id=code-81b2ebdaa363c995bce84a5e904484ee>etcdctl -C http://192.168.12.101:2379 cluster-health
etcdctl -C http://192.168.12.101:4001 cluster-health</code></pre><button class=copy-code-button onclick='copyCode("code-81b2ebdaa363c995bce84a5e904484ee",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>安装flannel：</p><div class="code-block code-block-container-indented"><pre><code id=code-a4283c635bbfc28d58b35bd5f276adf0>sudo yum -y install flannel</code></pre><button class=copy-code-button onclick='copyCode("code-a4283c635bbfc28d58b35bd5f276adf0",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>修改flannel的配置文件<code>/etc/sysconfig/flanneld</code>为如下内容，修改前可以先备份原来的配置文件：</p><div class="code-block code-block-container-indented"><pre><code id=code-2526ae4b41d2dbda76714f788608d25c>FLANNEL_ETCD=&#34;http://192.168.12.101:2379&#34;
FLANNEL_ETCD_KEY=&#34;/atomic.io/network&#34;
FLANNEL_OPTIONS=&#34;--iface=enp0s8&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-2526ae4b41d2dbda76714f788608d25c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>注意，配置文件里的<code>--iface=enp0s8</code>配置的是网卡，可以用<code>ip addr</code>命令查看，如果不配置网卡，可能会给不同主机的容器分配相同的ip地址</p></li><li><p>在etcd中设置flannel的key，用来保证多个flannel实例间的配置一致性：</p><div class="code-block code-block-container-indented"><pre><code id=code-7ebf069aec25edfe06d629a85c2bae0c>etcdctl mk /atomic.io/network/config &#39;{&#34;Network&#34;: &#34;192.168.0.0/16&#34;}&#39;</code></pre><button class=copy-code-button onclick='copyCode("code-7ebf069aec25edfe06d629a85c2bae0c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>设置的key要和flannel配置的相同。<code>Network</code>后的ip地址可以任意设定网段，容器ip会根据该网段自动分配。</p></li><li><p>启动flannel，重启docker，使flannel分配的ip生效：</p><div class="code-block code-block-container-indented"><pre><code id=code-9b42c42fd438b42b470a5603b6123453>sudo systemctl start flannel
sudo systemctl enable flannel
sudo systemctl restart docker</code></pre><button class=copy-code-button onclick='copyCode("code-9b42c42fd438b42b470a5603b6123453",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li></ol><h2 id=node2-配置>node2 配置</h2><ol><li><p>修改flannel的配置文件<code>/etc/sysconfig/flanneld</code>为如下内容，修改前可以先备份原来的配置文件：</p><div class="code-block code-block-container-indented"><pre><code id=code-2526ae4b41d2dbda76714f788608d25c>FLANNEL_ETCD=&#34;http://192.168.12.101:2379&#34;
FLANNEL_ETCD_KEY=&#34;/atomic.io/network&#34;
FLANNEL_OPTIONS=&#34;--iface=enp0s8&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-2526ae4b41d2dbda76714f788608d25c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>注意，配置文件里的<code>--iface=enp0s8</code>配置的是网卡，可以用<code>ip addr</code>命令查看，如果不配置网卡，可能会给不同主机的容器分配相同的ip地址</p></li><li><p>启动flannel，重启docker，使flannel分配的ip生效：</p><div class="code-block code-block-container-indented"><pre><code id=code-9b42c42fd438b42b470a5603b6123453>sudo systemctl start flannel
sudo systemctl enable flannel
sudo systemctl restart docker</code></pre><button class=copy-code-button onclick='copyCode("code-9b42c42fd438b42b470a5603b6123453",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li></ol><h2 id=启动容器进行测试>启动容器进行测试</h2><ol><li><p>在node1和node2中分别运行一个容器：</p><div class="code-block code-block-container-indented"><pre><code id=code-bc83cc9075e9b7d3f405aca4b5cd2d8d>sudo docker run -it ubuntu:14.04</code></pre><button class=copy-code-button onclick='copyCode("code-bc83cc9075e9b7d3f405aca4b5cd2d8d",this)' title=copy>
<i class="fa fa-copy"></i></button></div></li><li><p>在两个容器中互相ping对方ip，如果配置成功，则应该能ping通。否则请检查配置是否有错误，尤其是flannel配置网卡。</p></li></ol></article></div></main><div><h4 id=signature>Wed Nov 1, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/etcd>etcd</a></li><li><a href=https://number317.github.io/blog/tags/flannel>flannel</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/rabbitmq_access_control/>Rabbitmq Access Control</a></li><li><a class=next href=https://number317.github.io/blog/struct/maven_nexus/>Maven & Nexus</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>