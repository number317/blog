<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/rabbitmq_access_control/>Rabbitmq Access Control</a></li></ul><div id=content><main id=main><h1>Rabbitmq Access Control</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#默认虚拟主机和用户>默认虚拟主机和用户</a></li><li><a href=#权限工作方式>权限工作方式</a></li><li><a href=#虚拟主机virtual-host>虚拟主机(Virtual Host)</a></li><li><a href=#资源>资源</a></li></ul></nav></aside><article id=content><h1 id=rabbitmq-权限控制>Rabbitmq 权限控制</h1><p>在rabbitmq中，身份验证和授权是分开的。身份验证用于判断用户是谁，授权用于确定用户能做什么和不能做什么。</p><h2 id=默认虚拟主机和用户>默认虚拟主机和用户</h2><p>当服务第一次启动或者检测到数据库梅雨初始化或已经被删除，rabbitmq会初始化一个新的数据库，拥有如下资源：</p><ul><li>一个虚拟主机<code>/</code></li><li>一个用户名和密码都为<code>guest</code>的用户，拥有<code>/</code>虚拟主机的所有权限</li></ul><p>建议是删除默认用户或者修改默认用户的密码。<code>guest</code>用户默认情况只能通过localhost连接，无法通过远程连接。这可以通过配置文件修改，设置<code>loopback_users.guest = false</code>即可。</p><h2 id=权限工作方式>权限工作方式</h2><p>rabbitmq的权限控制主要分为两层，第一层是虚拟主机的权限，第二层是资源的权限。</p><h2 id=虚拟主机virtual-host>虚拟主机(Virtual Host)</h2><p>当客户端连接到服务器，它会指定一个要操作的虚拟主机，第一层权限控制被启用，服务器会检查用户对该虚拟主机是否有权限，没有权限连接会被拒绝。</p><p>示例：</p><p>首先创建一个用户：</p><div class="code-block code-block-container-indented"><pre><code id=code-ba34622ccbb0f3d027260dce1ade3cf8>rabbitmqctl add_user cheon 123</code></pre><button class=copy-code-button onclick='copyCode("code-ba34622ccbb0f3d027260dce1ade3cf8",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这里创建了一个用户cheon，密码为123（如果rabbitmq是集群，那么在集群中一个节点上创建了用户，虚拟主机等，在其他节点上也都会存在。）。刚创建的用户是没有任何权限的。可以确认一下用户的权限：</p><div class="code-block code-block-container-indented"><pre><code id=code-1bbcd6d76dde15cc0020c6b0a2b1d2c0>root@rabbitmq-node1:/# rabbitmqctl list_user_permissions cheon
Listing permissions for user &#34;cheon&#34; ...

root@rabbitmq-node1:/# rabbitmqctl list_user_permissions guest
Listing permissions for user &#34;guest&#34; ...
/	.*	.*	.*</code></pre><button class=copy-code-button onclick='copyCode("code-1bbcd6d76dde15cc0020c6b0a2b1d2c0",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>可以看到新用户cheon没有任何权限，guest用户拥有虚拟主机<code>/</code>的全部权限。</p><p>编写一个简单的脚本，通过用户cheon连接<code>/</code>虚拟主机，发送Hello World：</p><div class="code-block code-block-container-indented"><pre><code id=code-cff890a549acc4ec7c284405cb9758c9>#!/usr/bin/env python

import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(&#39;172.17.0.6&#39;, 5672, &#34;/&#34;, credentials=pika.PlainCredentials(&#39;cheon&#39;, &#39;123&#39;)))
channel = connection.channel()

channel.queue_declare(queue=&#39;hello&#39;)

channel.basic_publish(
        exchange=&#39;&#39;,
        routing_key=&#39;hello&#39;,
        body=&#39;Hello World!&#39;
        )

print(&#34; [x] Sent &#39;Helllo World!&#39;&#34;)

connection.close()</code></pre><button class=copy-code-button onclick='copyCode("code-cff890a549acc4ec7c284405cb9758c9",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>执行代码：</p><div class="code-block code-block-container-indented"><pre><code id=code-82189349590e5dbc6a6614457246ca30>=&gt; ./send.py 
Traceback (most recent call last):
  File &#34;./send.py&#34;, line 5, in &lt;module&gt;
    connection = pika.BlockingConnection(pika.ConnectionParameters(&#39;172.17.0.6&#39;, 5672, &#34;/&#34;, credentials=pika.PlainCredentials(&#39;cheon&#39;, &#39;123&#39;)))
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 377, in __init__
    self._process_io_for_connection_setup()
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 417, in _process_io_for_connection_setup
    self._open_error_result.is_ready)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 469, in _flush_output
    raise maybe_exception
pika.exceptions.ProbableAccessDeniedError: (530, &#34;NOT_ALLOWED - access to vhost &#39;/&#39; refused for user &#39;cheon&#39;&#34;)</code></pre><button class=copy-code-button onclick='copyCode("code-82189349590e5dbc6a6614457246ca30",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>可以发现报错是连接不被允许。</p><p>现在新建一个虚拟主机<code>myapp</code>：</p><div class="code-block code-block-container-indented"><pre><code id=code-af496983c4373505473deb1156125efb>rabbitmqctl add_vhost myapp</code></pre><button class=copy-code-button onclick='copyCode("code-af496983c4373505473deb1156125efb",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>然后为cheon添加对<code>myapp</code>的所有权限（要注意的是虽然guest是管理员帐号，但默认也没有连接新建虚拟主机的权限）：</p><div class="code-block code-block-container-indented"><pre><code id=code-74742511eb935297771ec49ff7377e4c>rabbitmqctl set_permissions -p myapp cheon &#34;.*&#34; &#34;.*&#34; &#34;.*&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-74742511eb935297771ec49ff7377e4c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>修改发送代码连接的虚拟主机：</p><div class="code-block code-block-container-indented"><pre><code id=code-9e832ee7782e4d5c04692b10eeb303ed>connection = pika.BlockingConnection(pika.ConnectionParameters(&#39;172.17.0.6&#39;, 5672, &#34;myapp&#34; credentials=pika.PlainCredentials(&#39;cheon&#39;, &#39;123&#39;)))</code></pre><button class=copy-code-button onclick='copyCode("code-9e832ee7782e4d5c04692b10eeb303ed",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>再次运行：</p><div class="code-block code-block-container-indented"><pre><code id=code-1d9d7bc2e5bd5fecc45ed340123b7a3e>=&gt; ./send.py 
 [x] Sent &#39;Helllo World!&#39;</code></pre><button class=copy-code-button onclick='copyCode("code-1d9d7bc2e5bd5fecc45ed340123b7a3e",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>可以发现连接成功，消息也发送成功。</p><h2 id=资源>资源</h2><p>资源(Resources)例如交换和队列，在特定的虚拟主机中是命名实体。相同的名字在不同的虚拟主机中也代表了不同的资源。当对资源进行操作时，第二层的权限控制被启用。rabbitmq将资源分为配置(configure)，写(write)，读(read)权限。配置操作创建，销毁或修改资源；写操作向资源注入消息；读操作从资源获取消息。</p><p>对资源的权限用三个正则表达式表示，每一个代表对应虚拟主机的配置，写和读。用户被授予对所有和正则表达式匹配的资源的权限。为了方便，rabbitmq映射AMQP的默认交换的空名字为<code>amq.default</code>。</p><p>正则表达式<code>^$</code>匹配空字符串，不允许用户对资源进行任何操作。标准的AMQP资源名字以<code>amq</code>为前缀。服务器生成的资源名字以<code>amq.gen</code>为前缀。例如，<code>^(amq\.gen.*|amq\.default)$</code>给予用户服务器生成的资源和默认交换的权限。空字符串<code>''</code>是<code>^$</code>同义词禁止用户权限。</p><p>示例：</p><p>先为<code>guest</code>用户添加能连接<code>myapp</code>虚拟主机的权限，但禁止它操作资源：</p><div class="code-block code-block-container-indented"><pre><code id=code-239bb0a98dc7cc437058ccfbe8559be2>root@rabbitmq-node2:/# rabbitmqctl set_permissions -p myapp guest &#34;&#34; &#34;&#34; &#34;&#34;
Setting permissions for user &#34;guest&#34; in vhost &#34;myapp&#34; ...</code></pre><button class=copy-code-button onclick='copyCode("code-239bb0a98dc7cc437058ccfbe8559be2",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>修改代码以<code>guest</code>用户来发送消息：</p><div class="code-block code-block-container-indented"><pre><code id=code-e986b03b301c7cb7418ea637a9df8667>connection = pika.BlockingConnection(pika.ConnectionParameters(&#39;172.17.0.6&#39;, 5672, &#34;myapp&#34;, credentials=pika.PlainCredentials(&#39;guest&#39;, &#39;guest&#39;)))</code></pre><button class=copy-code-button onclick='copyCode("code-e986b03b301c7cb7418ea637a9df8667",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>执行代码：</p><div class="code-block code-block-container-indented"><pre><code id=code-7b036302838f7529ab337fb92a21051d>=&gt; ./send.py 
Traceback (most recent call last):
  File &#34;./send.py&#34;, line 8, in &lt;module&gt;
    channel.queue_declare(queue=&#39;hello&#39;)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 2468, in queue_declare
    self._flush_output(declare_ok_result.is_ready)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 1292, in _flush_output
    *waiters)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 458, in _flush_output
    self._impl.ioloop.poll()
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/select_connection.py&#34;, line 495, in poll
    self._poller.poll()
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/select_connection.py&#34;, line 1114, in poll
    self._dispatch_fd_events(fd_event_map)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/select_connection.py&#34;, line 831, in _dispatch_fd_events
    handler(fileno, events)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/base_connection.py&#34;, line 410, in _handle_events
    self._handle_read()
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/base_connection.py&#34;, line 464, in _handle_read
    self._on_data_available(data)
  File &#34;/home/cheon/Docker/python/site-packages/pika/connection.py&#34;, line 2021, in _on_data_available
    self._process_frame(frame_value)
  File &#34;/home/cheon/Docker/python/site-packages/pika/connection.py&#34;, line 2142, in _process_frame
    if self._process_callbacks(frame_value):
  File &#34;/home/cheon/Docker/python/site-packages/pika/connection.py&#34;, line 2123, in _process_callbacks
    frame_value)  # Args
  File &#34;/home/cheon/Docker/python/site-packages/pika/callback.py&#34;, line 60, in wrapper
    return function(*tuple(args), **kwargs)
  File &#34;/home/cheon/Docker/python/site-packages/pika/callback.py&#34;, line 92, in wrapper
    return function(*args, **kwargs)
  File &#34;/home/cheon/Docker/python/site-packages/pika/callback.py&#34;, line 236, in process
    callback(*args, **keywords)
  File &#34;/home/cheon/Docker/python/site-packages/pika/adapters/blocking_connection.py&#34;, line 1358, in _on_channel_closed
    method.reply_text)
pika.exceptions.ChannelClosed: (403, &#34;ACCESS_REFUSED - access to queue &#39;hello&#39; in vhost &#39;myapp&#39; refused for user &#39;guest&#39;&#34;)</code></pre><button class=copy-code-button onclick='copyCode("code-7b036302838f7529ab337fb92a21051d",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>提示没有操作<code>hello</code>队列的权限。现在修改guest的权限，让guest有配置和写的权限：</p><div class="code-block code-block-container-indented"><pre><code id=code-d346da758ce6d9b8a3db0e0b23d2d77c>rabbitmqctl set_permissions -p myapp guest &#34;.*&#34; &#34;.*&#34; &#34;&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-d346da758ce6d9b8a3db0e0b23d2d77c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>再次执行：</p><div class="code-block code-block-container-indented"><pre><code id=code-1d9d7bc2e5bd5fecc45ed340123b7a3e>=&gt; ./send.py 
 [x] Sent &#39;Helllo World!&#39;</code></pre><button class=copy-code-button onclick='copyCode("code-1d9d7bc2e5bd5fecc45ed340123b7a3e",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>可以看到发送成功了，再运行消费者去消费：</p><div class="code-block code-block-container-indented"><pre><code id=code-012035c778d85959de531aafd0edd373>#!/usr/bin/env python

import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(&#39;172.17.0.6&#39;, 5672, &#34;myapp&#34;, credentials=pika.PlainCredentials(&#39;cheon&#39;, &#39;123&#39;)))
channel = connection.channel()

channel.queue_declare(queue=&#39;hello&#39;)

def callback(ch, method, properties, body):
    print(&#34; [x] Received %r&#34; % body)

channel.basic_consume(
        callback,
        queue=&#39;hello&#39;,
        no_ack=True
        )

print(&#39; [*] Waiting for message. To exit press CTRL&#43;C&#39;)
channel.start_consuming()</code></pre><button class=copy-code-button onclick='copyCode("code-012035c778d85959de531aafd0edd373",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这里的消费者用的是另一个用户cheon，因为他有读的权限，而guest没有读的权限，因此无法消费。</p><div class="code-block code-block-container-indented"><pre><code id=code-02fbb6cd27ff1f76ddb7a20479e1e806>=&gt; ./receive.py 
 [*] Waiting for message. To exit press CTRL&#43;C
 [x] Received b&#39;Hello World!&#39;</code></pre><button class=copy-code-button onclick='copyCode("code-02fbb6cd27ff1f76ddb7a20479e1e806",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>可以看到消费成功。</p><p>如果我们把guest的权限设置成<code>"hello" "hello" ""</code>，意味着guest对名为<code>hello</code>的交换和队列等资源有配置和写的权限，这样执行代码发送端不会报错，但用消费者去消费是收不到消息的，因为代码里用到了myapp默认的交换<code>''</code>，但guest没有设置权限，因此会发送失败。在权限控制的时候要注意这一点。</p></article></div></main><div><h4 id=signature>Mon Oct 30, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/rabbitmq>rabbitmq</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/rabbitmq_topic/>Rabbitmq Topic</a></li><li><a class=next href=https://number317.github.io/blog/struct/etcd_and_flannel/>Etcd & Flannel</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>