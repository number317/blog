<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><script src=https://number317.github.io/blog/js/single.js></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/docker_graph_migrate/>Docker Graph Migrate</a></li></ul><div id=content><main id=main><h1>Docker Graph Migrate</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#创建-lvm>创建 lvm</a></li><li><a href=#替换目录>替换目录</a></li></ul></nav></aside><article id=content><h1 id=docker-目录迁移>docker 目录迁移</h1><p>服务器根目录磁盘空间比较小，只有50G，在使用一段时间后镜像增多，磁盘不够用，准备将 docker 的目录挂载到新加的磁盘。挂载硬盘后如下：</p><div class="code-block code-block-container-indented"><pre><code id=code-ce7aeef8519f77a3c574ce87b688ffd0>NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sr0     11:0    1  3.7M  0 rom
vda    253:0    0   50G  0 disk
└─vda1 253:1    0   50G  0 part /
vdb    253:16   0  200G  0 disk</code></pre><button class=copy-code-button onclick='copyCode("code-ce7aeef8519f77a3c574ce87b688ffd0",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=创建-lvm>创建 lvm</h2><p>为了以后方便扩容，准备使用 lvm。首先创建 pv：</p><div class="code-block code-block-container-indented"><pre><code id=code-cf251ec788f2e49006c9f1e14662fcec>pvcreate /dev/vdb</code></pre><button class=copy-code-button onclick='copyCode("code-cf251ec788f2e49006c9f1e14662fcec",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>创建 vg，命名为 docker：</p><div class="code-block code-block-container-indented"><pre><code id=code-89b87f5e74e4ec2ab94e68ad3ce2480e>vgcreate docker /dev/vdb</code></pre><button class=copy-code-button onclick='copyCode("code-89b87f5e74e4ec2ab94e68ad3ce2480e",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>创建 lv，命名为 registry：</p><div class="code-block code-block-container-indented"><pre><code id=code-92db4c007d2c9588fc09f674b646c2f7>lvcreate -l &#43;100%Free docker --name registry</code></pre><button class=copy-code-button onclick='copyCode("code-92db4c007d2c9588fc09f674b646c2f7",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>将 lv 格式化为 xfs 文件系统：</p><div class="code-block code-block-container-indented"><pre><code id=code-bdb9e0c8dd6876a3112507390cf0e2bc>mkfs.xfs /dev/docker/registry</code></pre><button class=copy-code-button onclick='copyCode("code-bdb9e0c8dd6876a3112507390cf0e2bc",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=替换目录>替换目录</h2><p>首先要将改节点的 pod 全都驱散走：</p><div class="code-block code-block-container-indented"><pre><code id=code-af2922065a09e5aee804769bada98af8>kubectl cordon nodetest
kubectl drain nodetest --ignore-daemonsets --delete-local-data</code></pre><button class=copy-code-button onclick='copyCode("code-af2922065a09e5aee804769bada98af8",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>在节点上停止 docker 服务：</p><div class="code-block code-block-container-indented"><pre><code id=code-d760e36c469c9747522ffa8263970962>systemctl stop docker</code></pre><button class=copy-code-button onclick='copyCode("code-d760e36c469c9747522ffa8263970962",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>挂载目录到<code>Docker Root Dir</code>，如果不是这个默认路径，可以通过<code>docker info</code>命令查看：</p><div class="code-block code-block-container-indented"><pre><code id=code-d7cfe18c826bfffba1f939333f6d4576>mount /dev/docker/registry /var/lib/docker</code></pre><button class=copy-code-button onclick='copyCode("code-d7cfe18c826bfffba1f939333f6d4576",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>由于服务器上跑的容器都是无状态的，所以没有什么数据是需要保存的，无需备份，直接挂载。</p><p>重启 docker：</p><div class="code-block code-block-container-indented"><pre><code id=code-eeade48dcfe45c9d13a065ecbe49949b>systemctl restart docker</code></pre><button class=copy-code-button onclick='copyCode("code-eeade48dcfe45c9d13a065ecbe49949b",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>将 /dev/docker/registry 写入 <code>/etc/fstab</code> 文件：</p><div class="code-block code-block-container-indented"><pre><code id=code-8ab1d3940a719495b9128419c39e161c>/dev/docker/registry /var/lib/docker      xfs        defaults,noatime,nodiratime,nobarrier,discard,allocsize=256m,logbufs=8,attr2,logbsize=256k	0 0</code></pre><button class=copy-code-button onclick='copyCode("code-8ab1d3940a719495b9128419c39e161c",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>这样可以保证服务器重启时能自动挂载 /dev/docker/registry。由于新加的硬盘是 ssd，所以添加了一些针对 ssd 的参数。</p><p>最后重新将节点设置为可调度：</p><div class="code-block code-block-container-indented"><pre><code id=code-5773f0092dba4aa7b53dd70e5c6daf72>kubectl uncordon nodetest</code></pre><button class=copy-code-button onclick='copyCode("code-5773f0092dba4aa7b53dd70e5c6daf72",this)' title=copy>
<i class="fa fa-copy"></i></button></div></article></div></main><div><h4 id=signature>Tue May 14, 2019
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/docker>docker</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/skywalking_deploy/>Skywalking Deploy</a></li><li><a class=next href=https://number317.github.io/blog/struct/ceph_ansible/>Ceph Ansible</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>