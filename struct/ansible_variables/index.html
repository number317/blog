<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.font.im/css?family=Fira+Mono|Noto+Sans|Old+Standard+TT" rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://number317.github.io/blog/js/single.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.css rel=preload as=style onload='this.onload=null,this.rel="stylesheet"'><script src=https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.7/viewer.min.js async></script><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/ansible_variables/>Ansible Variables</a></li></ul><div id=content><main id=main><h1>Ansible Variables</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents><ul><li><a href=#playbook-variables>Playbook Variables</a></li><li><a href=#inventory-variables>Inventory variables</a></li><li><a href=#registered-variables>Registered Variables</a></li><li><a href=#accessing-variables>Accessing Variables</a></li><li><a href=#host-and-group-variables>Host and Group variables</a></li><li><a href=#magic-variables-with-host-and-group-variables-and-information>Magic variables with host and group variables and information</a></li><li><a href=#factsvariables-derived-from-system-information>Facts(Variables derived from system information)</a></li><li><a href=#local-factsfactsd>Local Facts(Facts.d)</a></li></ul></nav></aside><article id=content><h1 id=ansible-变量>ansible 变量</h1><p>ansible 变量以<code>[A-Za-z]</code>开头，可以包含下划线<code>_</code>和数字<code>[0-9]</code>，标准是全部使用小写字母。在清单(inventory)文件里，变量使用<code>=</code>赋值，如：</p><div class="code-block code-block-container-indented"><pre><code id=code-06ad47d8e64bd28de537b62ff85357c4>foo=bar</code></pre><button class=copy-code-button onclick='copyCode("code-06ad47d8e64bd28de537b62ff85357c4",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>在剧本(playbook)或变量文件里，变量用<code>:</code>赋值，如：</p><div class="code-block code-block-container-indented"><pre><code id=code-e1dcf98b4c823827be0a0524052ae95a>foo: bar</code></pre><button class=copy-code-button onclick='copyCode("code-e1dcf98b4c823827be0a0524052ae95a",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=playbook-variables>Playbook Variables</h2><p>变量可以在使用<code>ansible-playbook</code>时通过命令行参数<code>--extra-vars</code>选项传递：</p><div class="code-block code-block-container-indented"><pre><code id=code-484feec47e4bd8de85f27c7697db1e53>ansible-playbook example.yml --extra-vars &#34;foo=bar&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-484feec47e4bd8de85f27c7697db1e53",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>也可以在参数中传递json，yaml格式的数据，甚至是json和yaml文件，就像<code>--extra-vars "@even_more_vars.json"</code>或者<code>--extra-vars "@even_more_vars.yml"</code>，但这种方式不建议使用。</p><p>变量可以直接在playbook中的<code>vars</code>部分定义：</p><div class="code-block code-block-container-indented"><pre><code id=code-5fe217b69094bcd77d05ab7dcd671912>---
- hosts: example
  vars:
    foo: bar
  tasks:
    # Prints &#34;Variable &#39;foo&#39; is set to bar&#34;.
    - debug: msg=&#34;Variable &#39;foo&#39; is set to {{ foo }}&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-5fe217b69094bcd77d05ab7dcd671912",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>变量也可以在单独的文件中定义，然后在playbook中通过<code>vars_files</code>引用：</p><div class="code-block code-block-container-indented"><pre><code id=code-6327da43f56ba52e80cfb4227542efe9># Main playbook file.
- hosts: example
  vars_files:
    - vars.yml
  tasks:
	- debug: msg=&#34;Variable &#39;foo&#39; is set to {{ foo }}&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-6327da43f56ba52e80cfb4227542efe9",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>和playbook同目录下的<code>vars.yml</code>：</p><div class="code-block code-block-container-indented"><pre><code id=code-fa7a7b2e438de78b0406f4d728fcee9a># Variables file &#39;vars.yml&#39; in the same folder as the playbook.
foo: bar</code></pre><button class=copy-code-button onclick='copyCode("code-fa7a7b2e438de78b0406f4d728fcee9a",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>需要注意的是，当变量存放在单独的文件中，直接在yaml文件的顶层定义，不需要写<code>vars</code>之类的头。</p><p>变量可以根据条件导入。例如，对于CentOS服务器有一个变量集(Apache 服务被名名为 <code>httpd</code>)，对于Debian服务器有另一组变量(Apache 服务被命名为 <code>apache2</code>)，在这个例子中，可以使用可选择的<code>vars_files</code>：</p><div class="code-block code-block-container-indented"><pre><code id=code-3d8d02fcda0083d39f3ae3bd6cfca4f6>- hosts: example
  vars_files:
    - [ &#34;apache_{{ ansible_os_family }}.yml&#34;, &#34;apache_default.yml&#34; ]
  tasks:
    - service: name={{ apache }} state=running</code></pre><button class=copy-code-button onclick='copyCode("code-3d8d02fcda0083d39f3ae3bd6cfca4f6",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>然后在playbook的同一目录添加<code>apache_CentOS.yml</code>和<code>apache_default.yml</code>。在CentOS文件中定义变量<code>apache: httpd</code>，在default文件中定义变量<code>apache: apache2</code>。</p><p>只要在远程服务器上安装了<code>facter</code>或<code>ohai</code>，ansible可以读取服务器的系统信息，<code>ansible_os_family</code>就是其中一个。如果ansible找不到<code>ansible_os_family</code>对应的文件，就会使用第二个选项<code>apache_default.yml</code>。所以在Debian或Ubuntu服务器上，ansible将使用<code>apache2</code>作为服务名，即使没有<code>apache_Debian.yml</code>或<code>apache_Ubuntu.yml</code>文件。</p><h2 id=inventory-variables>Inventory variables</h2><p>变量可以通过 ansible inventory 文件添加，可以在host定义的同一行或者是一个组定义之后：</p><div class="code-block code-block-container-indented"><pre><code id=code-aa49aced6a6c009102c8e433db9c68e2># Host-specific variables (defined inline).
[washington]
app1.example.com proxy_state=present
app2.example.com proxy_state=absent
# Variables defined for the entire group.
[washington:vars]
cdn_host=washington.static.example.com
api_version=3.0.1</code></pre><button class=copy-code-button onclick='copyCode("code-aa49aced6a6c009102c8e433db9c68e2",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>如果想要定义许多变量，尤其是用于多个服务器的，inventory文件会变得笨重。事实上，ansible的官方文档建议<strong>不要</strong>用inventory文件来存储变量。建议使用<code>group_vars</code>和<code>host_vars</code> yaml变量文件。例如，为主机<code>app1.example.com</code>定义变量，创建一个空白文件<code>app1.example.com</code>，在文件中添加变量：</p><div class="code-block code-block-container-indented"><pre><code id=code-898f113b5decb813ba448a3e8c160dec>---
foo: bar
baz: qux</code></pre><button class=copy-code-button onclick='copyCode("code-898f113b5decb813ba448a3e8c160dec",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>要为整个<code>washington</code>组定义变量，创建一个相似的文件<code>washington</code>，可以将这些文件放置在playbook同一目录的<code>host_vars</code>和<code>group_vars</code>目录。ansible将会先使用在<code>[host|group]_vars</code>目录的清单文件定义的变量，然后会使用在playbook目录目录定义的变量。</p><h2 id=registered-variables>Registered Variables</h2><p>在很多情况下我们需要运行一个命令，然后使用它的返回值，错误输出或标准输出来判断是否执行下一个任务。在这种情况下，ansible 允许使用<code>register</code>将输出存储到变量中。例如：</p><div class="code-block code-block-container-indented"><pre><code id=code-a7b2cb44c9dae90f6d3596f26e8b5a2e>- name: &#34;Node: Check list of Node.js apps running.&#34;
  command: forever list
  register: forever_list
  changed_when: false

- name: &#34;Node: Start example Node.js app.&#34;
  command: forever start {{ node_apps_location }}/app/app.js
  when: &#34;forever_list.stdout.find(&#39;{{ node_apps_location}}/app/app.js&#39;) == -1&#34;</code></pre><button class=copy-code-button onclick='copyCode("code-a7b2cb44c9dae90f6d3596f26e8b5a2e",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>在上述的例子中，使用了Python内建的字符串函数<code>find</code>来搜索应用的路径。</p><h2 id=accessing-variables>Accessing Variables</h2><p>简单的变量(在inventory files, playbook, variable files 中定义的变量)可以使用语法<code>{{ variable }}</code>来当作任务的一部分。如：</p><div class="code-block code-block-container-indented"><pre><code id=code-e2b4d60349afa3492be9ac066f777b1d>- command: /opt/my-app/rebuild {{ my_environment }}</code></pre><button class=copy-code-button onclick='copyCode("code-e2b4d60349afa3492be9ac066f777b1d",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>当这个命令运行的时候，ansible将会用<code>my_environment</code>的内容代替<code>{{ my_environment }}</code>，命令的结果会是类似<code>/opt/my-app/rebuild dev</code>。</p><p>使用到的许多变量会是以列表的形式来构建的。直接使用列表<code>foo</code>将不会给你足够的可用信息(除非是ansible用到整个列表，像是<code>with_items</code>)。</p><p>如果定义一个列表：</p><div class="code-block code-block-container-indented"><pre><code id=code-f46dfbc0a5a478002f62719989faf9c2>foo_list:
  - one
  - two
  - three</code></pre><button class=copy-code-button onclick='copyCode("code-f46dfbc0a5a478002f62719989faf9c2",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>可以用两种语法获取第一个元素：</p><div class="code-block code-block-container-indented"><pre><code id=code-d6c22f5beebbe680458cf87d09ea9feb>foo[0]
foo|first</code></pre><button class=copy-code-button onclick='copyCode("code-d6c22f5beebbe680458cf87d09ea9feb",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>第一种方法使用标准的python语法，第二种方法使用一个Jinja2提供的简便的过滤器，两种方法是等价的。</p><p>对于更大更多的列表(例如获取服务器的IP地址)，可以通过列表的关键字来得到列表的任意位置的内容，使用<code>[]</code>或<code>.</code>语法。如<code>{{ ansible_eth0.ipv4.address }}</code>或<code>{{ ansible_eth0['ipv4']['address'] }}</code></p><h2 id=host-and-group-variables>Host and Group variables</h2><p>ansible 可以方便地定义或覆盖每个主机或组的变量。最简单的方法是直接在inventory文件中定义：</p><div class="code-block code-block-container-indented"><pre><code id=code-4ba9235624fceb09ca1904736f280f1d>[group]
host1 admin_user=jane
host2 admin_user=jack
host3

[group:vars]
admin_user=john</code></pre><button class=copy-code-button onclick='copyCode("code-4ba9235624fceb09ca1904736f280f1d",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>在上述例子中，ansible 将会使用<code>john</code>作为变量<code>{{ admin_user }}</code>的默认值，但是对于<code>host1</code>和<code>host2</code>，会使用自己定义的变量。</p><p>当playbooks复杂的时候，可能需要添加多个主机相关的变量。在这种情况下，可以在不同的地方定义这些变量。ansible会在inventory文件所在的目录搜索两个指定的目录：<code>group_vars</code>和<code>host_vars</code>。可以在这些目录里放置以组命名或以主机命名的yaml文件。例如：</p><div class="code-block code-block-container-indented"><pre><code id=code-6e87dc715944389a9173d420378b8e11>---
# File: /etc/ansible/group_vars/group
admin_user: john</code></pre><button class=copy-code-button onclick='copyCode("code-6e87dc715944389a9173d420378b8e11",this)' title=copy>
<i class="fa fa-copy"></i></button></div><div class="code-block code-block-container-indented"><pre><code id=code-74f77ef1ebf14f18356bccba9cd79108># File: /etc/ansible/host_vars/host1
admin_user: jane</code></pre><button class=copy-code-button onclick='copyCode("code-74f77ef1ebf14f18356bccba9cd79108",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>即使使用一个默认的inventory文件(或者是在playbook目录之外)，ansible也会使用playbook自己的<code>group_vars</code>和<code>host_vars</code>目录。当要把整个playbook和配置文件打包时，这是比较方便的。也可以定义<code>group_vars/all</code>文件用于所有组，<code>host_vars/all</code>文件用于所有主机。</p><h2 id=magic-variables-with-host-and-group-variables-and-information>Magic variables with host and group variables and information</h2><p>如果想要获取一个其他主机的变量，ansible定义了一个<code>hostvars</code>变量来包含所有定义的主机变量：</p><div class="code-block code-block-container-indented"><pre><code id=code-43ad359eee2ff4f498d07a23e37953dc># From any host, returns &#34;jane&#34;.
{{ hostvars[&#39;host1&#39;][&#39;admin_user&#39;] }}</code></pre><button class=copy-code-button onclick='copyCode("code-43ad359eee2ff4f498d07a23e37953dc",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>还有许多其他变量可能会时常用到：</p><ul><li>groups: inventory 文件中定义的组名的列表</li><li>group_names: 当前主机所属的组的列表</li><li>inventory_hostname: 当前主机的hostname</li><li>iventory_hostname_short: <code>inventory_hostname</code>的第一部分</li><li>play_hosts: 当前的play要运行的所有主机</li></ul><p>可以查看<a href=http://docs.ansible.com/playbooks_variables.html#magic-variables-and-how-to-access-information-about-other-hosts target=_blank rel="noopener noreferrer">
Magic Variables, and How To Access Information About Other Hosts
</a>获取更多信息。</p><h2 id=factsvariables-derived-from-system-information>Facts(Variables derived from system information)</h2><p>默认情况下，无论何时执行ansible playbook，ansible首先获取每个主机的信息(facts)。当运行playbook时，facts非常有用，像IP地址，CPU类型，磁盘空间，操作系统信息，网络接口信息等都可以获取到。要获取到所有facts的列表，可以使用setup模块：</p><div class="code-block code-block-container-indented"><pre><code id=code-40c29364d0c24471d08c03605d92e310>ansible all -m setup</code></pre><button class=copy-code-button onclick='copyCode("code-40c29364d0c24471d08c03605d92e310",this)' title=copy>
<i class="fa fa-copy"></i></button></div><p>如果不需要使用facts并且想要playbook执行快一点，可以在playbook中设置<code>gather_facts: no</code></p><div class="code-block code-block-container-indented"><pre><code id=code-7dc85f43cb78c4b11b84894dc96691f8>- hosts: db
  gather_facts: no</code></pre><button class=copy-code-button onclick='copyCode("code-7dc85f43cb78c4b11b84894dc96691f8",this)' title=copy>
<i class="fa fa-copy"></i></button></div><h2 id=local-factsfactsd>Local Facts(Facts.d)</h2><p>另一种定义指定主机的变量是放置<code>.fact</code>文件到指定目录<code>/etc/ansible/facts.d</code>，这些文件可以是JSON或INI文件，也可以是一个返回JSON的可执行文件。例如，创建一个文件<code>/etc/ansible/facts.d/settings.fact</code>:</p><div class="code-block code-block-container-indented"><pre><code id=code-118803c90c044d1cc29dda16f6348b2f>[users]
admin=jane,john
normal=jim</code></pre><button class=copy-code-button onclick='copyCode("code-118803c90c044d1cc29dda16f6348b2f",this)' title=copy>
<i class="fa fa-copy"></i></button></div><div class="code-block code-block-container-indented"><pre><code id=code-26c0c132d777f4979b1f366e3e83b027>ansible hostname -m setup -a &#34;filter=ansible_local&#34;
munin.midwesternmac.com | success &gt;&gt; {
    &#34;ansible_facts&#34;: {
        &#34;ansible_local&#34;: {
            &#34;settings&#34;: {
                &#34;users&#34;: {
                    &#34;admin&#34;: &#34;jane,john&#34;,
                    &#34;normal&#34;: &#34;jim&#34;
                }
             }
        }
    },
    &#34;changed&#34;: false
}</code></pre><button class=copy-code-button onclick='copyCode("code-26c0c132d777f4979b1f366e3e83b027",this)' title=copy>
<i class="fa fa-copy"></i></button></div></article></div></main><div><h4 id=signature>Fri May 25, 2018
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/ansible>ansible</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/glusterfs_deploy/>Glusterfs Deploy</a></li><li><a class=next href=https://number317.github.io/blog/struct/graylog_k8s_install/>Graylog K8s Install</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>