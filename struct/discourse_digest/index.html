<!doctype html><html><head><meta charset=utf-8><meta name=description content="Aloha! Welcome to cheon's blog."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=76x76 href=https://number317.github.io/blog/img/apple-touch-icon.png><link rel=icon href=https://number317.github.io/blog/img/pen.svg><link rel=stylesheet href=https://number317.github.io/blog/css/global.css><link rel=stylesheet href=https://number317.github.io/blog/css/nav.css><link rel=stylesheet href=https://number317.github.io/blog/css/header.css><link rel=stylesheet href=https://number317.github.io/blog/css/index.css><link rel=stylesheet href=https://number317.github.io/blog/css/list.css><link rel=stylesheet href=https://number317.github.io/blog/css/single.css><link rel=stylesheet href=https://number317.github.io/blog/css/footer.css><link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><title>cheon's blog</title></head><body><section id=header><ul id=menus><li class=menu><a href=https://number317.github.io><span>Home</span></a></li><li class=menu><a href=https://number317.github.io/blog/categories><span>Categories</span></a></li><li class=menu><a href=https://number317.github.io/blog/tags><span>Tags</span></a></li><li class=menu><a href=https://github.com/number317><span>Projects</span></a></li></ul><h1 id=title><a href=https://number317.github.io/blog/>cheon's blog</a></h1></section><ul id=nav><li>»
<a href=https://number317.github.io/blog/>cheon's blog</a></li><li>»
<a href=https://number317.github.io/blog/struct/>struct</a></li><li class=active>»
<a href=https://number317.github.io/blog/struct/discourse_digest/>Discourse Digest</a></li></ul><div id=content><main id=main><h1>Discourse Digest</h1><time>Last updated Fri Jun 14, 2019</time><div><aside><h2>Table of Content</h1><nav id=TableOfContents></nav></aside><article id=content><h1 id=问题说明>问题说明</h1><ul><li>discourse 版本：v1.9.0.beta12 +49</li><li>discourse 域名: <a href=http://test.test.com/community>http://test.test.com/community</a></li><li>详细情况：discourse 配置好二级域名后，摘要邮件中取消订阅链接错误</li></ul><h1 id=解决方法>解决方法</h1><ol><li><p>进入到服务器中discourse的部署目录，运行<code>./launcher enter discourse</code>进入到容器中</p></li><li><p>进入到<code>/var/www/discourse/app/views/user_notifications</code>目录，该目录下有两个文件</p><ul><li><code>digest.html.erb</code></li><li><code>digest.text.erb</code></li></ul><p>分别代表html格式的邮件和text格式的邮件</p></li><li><p>编辑<code>digest.html.erb</code>文件，找到如下内容:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>&lt;div dir=<span style=color:#666;font-style:italic>&#34;&lt;%= rtl? ? &#39;rtl&#39; : &#39;ltr&#39; %&gt;&#34;</span> class=<span style=color:#666;font-style:italic>&#39;footer&#39;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#666;font-style:italic>%=raw(t &#39;user_notifications.digest.unsubscribe&#39;,
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>        site_link: html_site_link(@anchor_color),
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>        email_settings_url: Discourse.base_url + &#39;/my/preferences/emails&#39;,
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>        unsubscribe_link: link_to(t(&#39;user_notifications.digest.click_here&#39;), email_unsubscribe_url(host: Discourse.base_url_no_prefix, key: @unsubscribe_key), {:style=</span>&gt;<span style=color:#666;font-style:italic>&#34;color: #</span><span style=color:#666;font-style:italic>#{</span>@anchor_color<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>}))  <span style=color:#666;font-style:italic>%&gt;
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>&lt;/div&gt;</span>
</span></span></code></pre></div><p>该部分内容定义了html格式邮件的footer，三个url分别代表站点地址，邮件设置地址，取消订阅地址。需要修改的地方是将<code>email_unsubscribe_url</code>中的<code>host</code>部分的<code>Discourse.base_url_no_prefix</code>替换为<code>Discourse.base_url</code></p><p>整段内容替换好后如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>&lt;div dir=<span style=color:#666;font-style:italic>&#34;&lt;%= rtl? ? &#39;rtl&#39; : &#39;ltr&#39; %&gt;&#34;</span> class=<span style=color:#666;font-style:italic>&#39;footer&#39;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#666;font-style:italic>%=raw(t &#39;user_notifications.digest.unsubscribe&#39;,
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>        site_link: html_site_link(@anchor_color),
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>        email_settings_url: Discourse.base_url + &#39;/my/preferences/emails&#39;,
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>        unsubscribe_link: link_to(t(&#39;user_notifications.digest.click_here&#39;), email_unsubscribe_url(host: Discourse.base_url, key: @unsubscribe_key), {:style=</span>&gt;<span style=color:#666;font-style:italic>&#34;color: #</span><span style=color:#666;font-style:italic>#{</span>@anchor_color<span style=color:#666;font-style:italic>}</span><span style=color:#666;font-style:italic>&#34;</span>}))  <span style=color:#666;font-style:italic>%&gt;
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic>&lt;/div&gt;</span>
</span></span></code></pre></div></li><li><p>退出discourse容器，重启容器即可</p></li></ol></article></div></main><div><h4 id=signature>Tue Oct 24, 2017
cheon</h4><ul class=tags><li><a href=https://number317.github.io/blog/tags/discourse>discourse</a></li></ul><ul class=related><li><a class=previous href=https://number317.github.io/blog/struct/discourse_cas/>Discourse Cas</a></li><li><a class=next href=https://number317.github.io/blog/struct/rabbitmq_cluster/>Rabbitmq Cluster</a></li></ul></div></div><section id=footer><div id=author><h2>About Author</h2><hr><img src=https://number317.github.io/images/author.jpg></img><p>Life is dance we all have to do.</p></div><ul id=link><li><a href=https://github.com/number317/aloha.git target=_blank><i class="fa fa-github" alt=github></i></a></li><li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target=_blank><i class="fa fa-envelope" alt=email></i></a></li><li id=wechat><i class="fa fa-wechat"></i></li><img class=qrcode src=https://number317.github.io/images/wechat.jpg></ul></section></body></html>